<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Seguimiento de Auditoría - FIAS</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Font Awesome para iconos -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    
    <!-- DataTables CSS -->
    <link rel="stylesheet" href="https://cdn.datatables.net/2.0.7/css/dataTables.bootstrap5.min.css">

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- MSAL -->
    <script src="https://alcdn.msauth.net/browser/2.14.2/js/msal-browser.min.js"></script>

    <style>
        :root {
            --fias-primary: #2c7d32;
            --fias-secondary: #8bc34a;
            --fias-accent: #ffc107;
        }
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .navbar, .card-header {
            background-color: var(--fias-primary);
            color: white;
        }
        .footer {
            background-color: #343a40;
            color: white;
            padding: 1rem 0;
            text-align: center;
        }
        .kpi-card {
            border-left: 5px solid var(--fias-primary);
        }
        /* Estilo para el loader */
        #loading {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            opacity: 1;
            transition: opacity 0.3s ease;
        }
        .spinner {
            border: 8px solid #f3f3f3;
            border-top: 8px solid var(--fias-primary);
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1.5s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="d-flex flex-column min-vh-100">

    <!-- Pantalla de Carga -->
    <div id="loading">
        <div class="spinner"></div>
    </div>

    <!-- Pantalla de Login -->
    <div id="login-screen" class="container">
        <div class="row min-vh-100 justify-content-center align-items-center">
            <div class="col-md-6 text-center">
                <div class="card shadow-lg">
                    <div class="card-body p-5">
                         <img src="https://placehold.co/150x80/2c7d32/FFFFFF?text=FIAS+Logo" alt="Logo FIAS" class="mx-auto mb-4">
                        <h1 class="card-title h3 mb-3">Dashboard de Seguimiento de Auditoría</h1>
                        <p class="card-text text-muted mb-4">Por favor, inicie sesión para continuar.</p>
                        <button id="signInButton" class="btn btn-success btn-lg w-100">
                            <i class="fab fa-microsoft me-2"></i> Iniciar Sesión con Microsoft
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Contenido Principal del Dashboard (oculto por defecto) -->
    <div id="dashboard-content" class="d-none flex-grow-1">
        <!-- Encabezado -->
        <nav class="navbar navbar-expand-lg navbar-dark shadow-sm">
            <div class="container-fluid">
                <a class="navbar-brand" href="#">
                    <i class="fas fa-tasks me-2"></i> Dashboard de Recomendaciones
                </a>
                <div class="d-flex align-items-center">
                    <span id="welcome-message" class="navbar-text me-3 d-none d-md-block"></span>
                    <button id="refreshData" class="btn btn-light me-2" title="Actualizar Datos">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                    <button id="signOutButton" class="btn btn-danger">
                        <i class="fas fa-sign-out-alt me-2"></i>Cerrar Sesión
                    </button>
                </div>
            </div>
        </nav>

        <!-- Contenido principal -->
        <main class="container-fluid mt-4">
            <!-- Filtros -->
            <div class="card shadow-sm mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-filter me-2"></i>Filtros</h5>
                </div>
                <div class="card-body">
                    <div class="row g-3 align-items-end">
                        <div class="col-md-3">
                            <label for="filter-year" class="form-label">Año</label>
                            <select id="filter-year" class="form-select"><option value="">Todos</option></select>
                        </div>
                        <div class="col-md-3">
                            <label for="filter-risk" class="form-label">Nivel de Riesgo</label>
                            <select id="filter-risk" class="form-select"><option value="">Todos</option></select>
                        </div>
                        <div class="col-md-3">
                            <label for="filter-status" class="form-label">Estado</label>
                            <select id="filter-status" class="form-select"><option value="">Todos</option></select>
                        </div>
                        <div class="col-md-3 d-flex">
                            <button id="apply-filters" class="btn btn-primary w-50 me-2"><i class="fas fa-check me-2"></i>Aplicar</button>
                            <button id="reset-filters" class="btn btn-secondary w-50"><i class="fas fa-undo me-2"></i>Limpiar</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- KPIs -->
            <div class="row g-4 mb-4">
                <div class="col-md-3"><div class="card kpi-card shadow-sm"><div class="card-body text-center"><p class="text-muted">Total Recomendaciones</p><h3 id="kpi-total" class="fw-bold">0</h3></div></div></div>
                <div class="col-md-3"><div class="card kpi-card shadow-sm"><div class="card-body text-center"><p class="text-muted">Cumplidas</p><h3 id="kpi-completed" class="fw-bold">0</h3></div></div></div>
                <div class="col-md-3"><div class="card kpi-card shadow-sm"><div class="card-body text-center"><p class="text-muted">En Proceso</p><h3 id="kpi-in-progress" class="fw-bold">0</h3></div></div></div>
                <div class="col-md-3"><div class="card kpi-card shadow-sm"><div class="card-body text-center"><p class="text-muted">Pendientes</p><h3 id="kpi-pending" class="fw-bold">0</h3></div></div></div>
            </div>

            <!-- Gráficos -->
            <div class="row g-4 mb-4">
                <div class="col-lg-5">
                    <div class="card shadow-sm h-100"><div class="card-body"><h5 class="card-title">Recomendaciones por Estado</h5><canvas id="statusChart"></canvas></div></div>
                </div>
                 <div class="col-lg-7">
                    <div class="card shadow-sm h-100"><div class="card-body"><h5 class="card-title">Recomendaciones por Nivel de Riesgo</h5><canvas id="riskChart"></canvas></div></div>
                </div>
            </div>

            <!-- Tabla de Datos -->
            <div class="card shadow-sm">
                <div class="card-header"><h5 class="mb-0">Detalle de Recomendaciones</h5></div>
                <div class="card-body"><div class="table-responsive"><table id="recommendationsTable" class="table table-striped table-hover w-100"></table></div></div>
            </div>
        </main>
    </div>
    
    <!-- Footer -->
    <footer class="footer mt-auto">
        <div class="container">
            <span>Desarrollado por Jair Cruz</span>
        </div>
    </footer>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/2.0.7/js/dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/2.0.7/js/dataTables.bootstrap5.min.js"></script>

    <script type="module">
        const msalConfig = {
            auth: {
                clientId: "deff0a8a-9d8b-4463-8d8f-382b82476757",
                authority: "https://login.microsoftonline.com/fias.org.ec",
                redirectUri: "https://jaircruz1304.github.io/FIAS/Cerrar.html",
                postLogoutRedirectUri: "https://jaircruz1304.github.io/FIAS/Cerrar.html",
                mainWindowRedirectUri: "https://jaircruz1304.github.io/FIAS/Cerrar.html"
            },
            cache: { cacheLocation: "sessionStorage", storeAuthStateInCookie: false }
        };

        const msalInstance = new msal.PublicClientApplication(msalConfig);
        const graphApiEndpoint = "https://graph.microsoft.com/v1.0/sites/fias.sharepoint.com,d1418e69-1c9f-442d-a640-59f772421bb9,420b70d8-4f91-455c-a56b-2f08518903c7/drives/b!aZ4Y0Z8cLUSmQFn3ckIbuZgwcEkR-VxFpWsvmAhRgzfB7XC0n5FrSYsU3M58Kx7I/items/01AZTUUFJQ6B6P2O53BGY2L2752X3V6PXH/workbook/worksheets('RECOMENDACIONES AUD EXTERNA')/usedRange";
        const loginRequest = { scopes: ["User.Read", "Sites.Read.All"] };

        let allRecommendations = [];
        let dataTable;
        let statusChartInstance, riskChartInstance;
        
        const loadingEl = document.getElementById('loading');
        const loginScreenEl = document.getElementById('login-screen');
        const dashboardContentEl = document.getElementById('dashboard-content');

        async function initializeApp() {
            try {
                const accounts = msalInstance.getAllAccounts();
                if (accounts.length > 0) {
                    msalInstance.setActiveAccount(accounts[0]);
                    await showDashboard(accounts[0]);
                } else {
                    showLogin();
                }
            } catch (error) {
                console.error("Initialization error:", error);
                showLogin();
            }
        }

        async function signIn() {
            try {
                const response = await msalInstance.loginPopup(loginRequest);
                msalInstance.setActiveAccount(response.account);
                await showDashboard(response.account);
            } catch (error) { console.error("Login failed:", error); }
        }

        function signOut() {
            msalInstance.logoutPopup({ account: msalInstance.getActiveAccount() });
        }
        
        async function getToken() {
            const account = msalInstance.getActiveAccount();
            if (!account) throw new Error("No active account!");
            const request = { ...loginRequest, account };
            try {
                const response = await msalInstance.acquireTokenSilent(request);
                return response.accessToken;
            } catch (error) {
                if (error instanceof msal.InteractionRequiredAuthError) {
                    const response = await msalInstance.acquireTokenPopup(request);
                    return response.accessToken;
                }
                throw error;
            }
        }

        function showLogin() {
            loadingEl.style.display = 'none';
            loginScreenEl.classList.remove('d-none');
            dashboardContentEl.classList.add('d-none');
        }
        
        async function showDashboard(account) {
            document.getElementById('welcome-message').innerText = `Bienvenido, ${account.name}`;
            loginScreenEl.classList.add('d-none');
            dashboardContentEl.classList.remove('d-none');
            loadingEl.style.display = 'flex';
            
            await loadDataFromExcel();
            
            loadingEl.style.display = 'none';
        }

        async function loadDataFromExcel() {
            loadingEl.style.display = 'flex';
            try {
                const token = await getToken();
                const response = await fetch(graphApiEndpoint, { headers: { 'Authorization': `Bearer ${token}` } });
                if (!response.ok) throw new Error(`API Error: ${response.statusText}`);
                
                const data = await response.json();
                
                // Normalizar encabezados y mapear datos
                const headers = data.values[0].map(header => 
                    header.toLowerCase().trim()
                    .replace(/ /g, '_')
                    .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
                );
                
                allRecommendations = data.values.slice(1).map(row => {
                    const item = {};
                    headers.forEach((key, index) => {
                        item[key] = row[index] || '';
                    });
                    return item;
                }).filter(item => item.proyecto); // Filtrar filas vacías

                populateFilters();
                if (!dataTable) initializeDataTable();
                updateDashboard(allRecommendations);

            } catch (error) {
                console.error('Failed to load data:', error);
                alert("Error al cargar los datos. Verifique la consola e intente iniciar sesión de nuevo.");
                signOut();
            } finally {
                loadingEl.style.display = 'none';
            }
        }

        function populateFilters() {
            // Renombrar 'ano' a 'año' para que coincida con el encabezado normalizado
            const years = [...new Set(allRecommendations.map(item => item.año))].sort((a,b) => b-a);
            const risks = [...new Set(allRecommendations.map(item => item.riesgo))].sort();
            const statuses = [...new Set(allRecommendations.map(item => item.estado))].sort();
            
            const populate = (el, items) => { el.innerHTML = '<option value="">Todos</option>' + items.map(i => `<option value="${i}">${i}</option>`).join(''); };
            populate(document.getElementById('filter-year'), years);
            populate(document.getElementById('filter-risk'), risks);
            populate(document.getElementById('filter-status'), statuses);
        }
        
        function applyFilters() {
            const selectedYear = document.getElementById('filter-year').value;
            const selectedRisk = document.getElementById('filter-risk').value;
            const selectedStatus = document.getElementById('filter-status').value;
            
            const filteredData = allRecommendations.filter(item => 
                (!selectedYear || item.año == selectedYear) &&
                (!selectedRisk || item.riesgo === selectedRisk) &&
                (!selectedStatus || item.estado === selectedStatus)
            );
            updateDashboard(filteredData);
        }

        function resetFilters() {
            document.getElementById('filter-year').value = '';
            document.getElementById('filter-risk').value = '';
            document.getElementById('filter-status').value = '';
            updateDashboard(allRecommendations);
        }
        
        function initializeDataTable() {
            dataTable = $('#recommendationsTable').DataTable({
                data: [],
                columns: [
                    { data: 'proyecto', title: 'Proyecto' },
                    { data: 'año', title: 'Año' },
                    { data: 'riesgo', title: 'Riesgo' },
                    { data: 'recomendacion', title: 'Recomendación' },
                    { data: 'estado', title: 'Estado' },
                    { data: 'responsable', title: 'Responsable' }
                ],
                responsive: true,
                language: { url: '//cdn.datatables.net/plug-ins/2.0.7/i18n/es-ES.json' },
            });
        }
        
        function updateDashboard(data) {
            const total = data.length;
            const completed = data.filter(r => r.estado?.toLowerCase().includes('cumplido')).length;
            const inProgress = data.filter(r => r.estado?.toLowerCase().includes('proceso')).length;
            const pending = total - completed - inProgress;

            document.getElementById('kpi-total').innerText = total;
            document.getElementById('kpi-completed').innerText = completed;
            document.getElementById('kpi-in-progress').innerText = inProgress;
            document.getElementById('kpi-pending').innerText = pending;

            updateStatusChart(data);
            updateRiskChart(data);
            
            dataTable.clear().rows.add(data).draw();
        }

        function updateStatusChart(data) {
            const ctx = document.getElementById('statusChart').getContext('2d');
            const statusCounts = data.reduce((acc, {estado}) => { acc[estado] = (acc[estado] || 0) + 1; return acc; }, {});
            if (statusChartInstance) statusChartInstance.destroy();
            statusChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(statusCounts),
                    datasets: [{ data: Object.values(statusCounts), backgroundColor: ['#28a745', '#ffc107', '#dc3545', '#6c757d'] }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }
        
        function updateRiskChart(data) {
            const ctx = document.getElementById('riskChart').getContext('2d');
            const riskCounts = data.reduce((acc, {riesgo}) => { acc[riesgo] = (acc[riesgo] || 0) + 1; return acc; }, {});
            if (riskChartInstance) riskChartInstance.destroy();
            riskChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(riskCounts),
                    datasets: [{ label: '# de Recomendaciones', data: Object.values(riskCounts), backgroundColor: ['#dc3545', '#ffc107', '#28a745'] }]
                },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } }, plugins: { legend: { display: false } } }
            });
        }

        document.getElementById('signInButton').addEventListener('click', signIn);
        document.getElementById('signOutButton').addEventListener('click', signOut);
        document.getElementById('refreshData').addEventListener('click', loadDataFromExcel);
        document.getElementById('apply-filters').addEventListener('click', applyFilters);
        document.getElementById('reset-filters').addEventListener('click', resetFilters);

        initializeApp();
    </script>
</body>
</html>

