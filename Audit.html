<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Seguimiento de Recomendaciones - FIAS</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- DataTables CSS -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.5/css/dataTables.bootstrap5.min.css">
    <style>
        :root {
            --fias-primary: #2c7d32;
            --fias-secondary: #8bc34a;
            --fias-accent: #ffc107;
        }
        
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .navbar {
            background-color: var(--fias-primary);
        }
        
        .card-header {
            background-color: var(--fias-primary);
            color: white;
        }
        
        .status-badge {
            padding: 0.5em 1em;
            border-radius: 20px;
            font-weight: 600;
        }
        
        .status-en-proceso {
            background-color: #fff3cd;
            color: #856404;
        }
        
        .status-cumplido {
            background-color: #d4edda;
            color: #155724;
        }
        
        .status-cumplido-parcial {
            background-color: #cce5ff;
            color: #004085;
        }
        
        .status-no-cumplido {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        .status-no-implementara {
            background-color: #e2e3e5;
            color: #383d41;
        }
        
        .status-pendiente {
            background-color: #d1ecf1;
            color: #0c5460;
        }
        
        .status-no-aplica {
            background-color: #f8f9fa;
            color: #6c757d;
        }
        
        .risk-high {
            border-left: 5px solid #dc3545;
        }
        
        .risk-medium {
            border-left: 5px solid #ffc107;
        }
        
        .risk-low {
            border-left: 5px solid #28a745;
        }
        
        .dashboard-card {
            transition: transform 0.3s;
            border: none;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .dashboard-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }
        
        .chart-container {
            position: relative;
            height: 250px;
        }
        
        .progress {
            height: 10px;
        }
        
        .filter-section {
            background-color: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        
        .logo-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .logo-icon {
            font-size: 24px;
            color: white;
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .spinner-border {
            width: 3rem;
            height: 3rem;
        }
        
        .auth-container {
            max-width: 500px;
            margin: 50px auto;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .config-help {
            background-color: #f8f9fa;
            border-left: 4px solid #0d6efd;
            padding: 15px;
            margin-top: 20px;
        }
        
        .no-data-message {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="text-center">
            <div class="spinner-border text-success" role="status">
                <span class="visually-hidden">Cargando...</span>
            </div>
            <p class="mt-3" id="loadingText">Conectando con Excel Online...</p>
        </div>
    </div>

    <!-- Contenedor de configuración para desarrollo -->
    <div id="configContainer" class="auth-container" style="display: none;">
        <div class="text-center mb-4">
            <i class="fas fa-cogs fa-3x text-primary"></i>
            <h3 class="mt-2">Configuración Requerida</h3>
            <p>Para que la aplicación funcione correctamente, necesita configurar el Redirect URI en Azure AD.</p>
        </div>
        
        <div class="config-help">
            <h5>Pasos para configurar Azure AD:</h5>
            <ol>
                <li>Inicie sesión en <a href="https://portal.azure.com/" target="_blank">Azure Portal</a></li>
                <li>Vaya a <strong>Azure Active Directory</strong> > <strong>Registros de aplicaciones</strong></li>
                <li>Seleccione su aplicación <strong>"Auditoria - Recomendaciones"</strong></li>
                <li>Vaya a la sección <strong>"Autenticación"</strong></li>
                <li>Agregue estos Redirect URIs:
                    <ul>
                        <li><code>https://jaircruz1304.github.io</code></li>
                        <li><code>http://localhost:8000</code> (para desarrollo)</li>
                    </ul>
                </li>
                <li>Guarde los cambios</li>
            </ol>
            <p class="mb-0">Después de configurar, <button class="btn btn-sm btn-success" onclick="location.reload()">recargue la página</button></p>
        </div>
        
        <div class="mt-3">
            <button class="btn btn-primary w-100" onclick="window.open('https://portal.azure.com/', '_blank')">
                <i class="fas fa-external-link-alt me-2"></i> Abrir Azure Portal
            </button>
        </div>
    </div>

    <!-- Contenedor de autenticación (inicialmente oculto) -->
    <div id="authContainer" class="auth-container" style="display: none;">
        <div class="text-center mb-4">
            <i class="fas fa-leaf fa-3x text-success"></i>
            <h3 class="mt-2">Autenticación requerida</h3>
            <p>Para acceder a los datos del Excel, necesita autenticarse con su cuenta de Office 365.</p>
        </div>
        <button id="loginBtn" class="btn btn-success w-100">
            <i class="fas fa-sign-in-alt me-2"></i> Iniciar sesión con Microsoft
        </button>
        <div class="mt-3 text-center">
            <small class="text-muted">Utilice su cuenta corporativa de FIAS</small>
        </div>
    </div>

    <!-- Contenido principal (inicialmente oculto) -->
    <div id="mainContent" style="display: none;">
        <!-- Navbar -->
        <nav class="navbar navbar-expand-lg navbar-dark">
            <div class="container">
                <div class="logo-container">
                    <i class="fas fa-leaf logo-icon"></i>
                    <a class="navbar-brand" href="#">FIAS - Seguimiento de Recomendaciones</a>
                </div>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav ms-auto">
                        <li class="nav-item">
                            <a class="nav-link active" href="#"><i class="fas fa-home me-1"></i> Inicio</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#"><i class="fas fa-chart-bar me-1"></i> Dashboard</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#"><i class="fas fa-list me-1"></i> Recomendaciones</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#"><i class="fas fa-user me-1"></i> Auditoría Interna</a>
                        </li>
                        <li class="nav-item">
                            <button class="btn btn-outline-light btn-sm mt-1" id="refreshData">
                                <i class="fas fa-sync-alt me-1"></i> Actualizar
                            </button>
                        </li>
                        <li class="nav-item">
                            <button class="btn btn-outline-light btn-sm mt-1 ms-2" id="logoutBtn">
                                <i class="fas fa-sign-out-alt me-1"></i> Cerrar sesión
                            </button>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>

        <div class="container mt-4">
            <!-- Filtros -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="filter-section">
                        <div class="row">
                            <div class="col-md-3 mb-2">
                                <label for="projectFilter" class="form-label">Proyecto</label>
                                <select class="form-select" id="projectFilter">
                                    <option value="">Todos los proyectos</option>
                                    <!-- Se llenará dinámicamente -->
                                </select>
                            </div>
                            <div class="col-md-3 mb-2">
                                <label for="yearFilter" class="form-label">Año</label>
                                <select class="form-select" id="yearFilter">
                                    <option value="">Todos los años</option>
                                    <!-- Se llenará dinámicamente -->
                                </select>
                            </div>
                            <div class="col-md-3 mb-2">
                                <label for="statusFilter" class="form-label">Estado</label>
                                <select class="form-select" id="statusFilter">
                                    <option value="">Todos los estados</option>
                                    <!-- Se llenará dinámicamente -->
                                </select>
                            </div>
                            <div class="col-md-3 mb-2">
                                <label for="riskFilter" class="form-label">Nivel de Riesgo</label>
                                <select class="form-select" id="riskFilter">
                                    <option value="">Todos los niveles</option>
                                    <option value="ALTO">ALTO</option>
                                    <option value="MEDIO">MEDIO</option>
                                    <option value="BAJO">BAJO</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Dashboard Cards -->
            <div class="row mb-4" id="dashboardCards">
                <div class="col-12">
                    <div class="no-data-message">
                        <i class="fas fa-database fa-3x mb-3"></i>
                        <h4>Esperando datos de Excel</h4>
                        <p>Los datos se cargarán automáticamente después de la autenticación.</p>
                    </div>
                </div>
            </div>

            <!-- Charts -->
            <div class="row mb-4">
                <div class="col-md-6 mb-3">
                    <div class="card dashboard-card">
                        <div class="card-header">
                            <h5 class="mb-0">Recomendaciones por Estado</h5>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="statusChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6 mb-3">
                    <div class="card dashboard-card">
                        <div class="card-header">
                            <h5 class="mb-0">Recomendaciones por Nivel de Riesgo</h5>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="riskChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tabla de Recomendaciones -->
            <div class="row">
                <div class="col-12">
                    <div class="card dashboard-card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">Lista de Recomendaciones</h5>
                            <div>
                                <button class="btn btn-sm btn-outline-light" id="exportBtn">
                                    <i class="fas fa-download me-1"></i> Exportar
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="no-data-message">
                                <i class="fas fa-table fa-3x mb-3"></i>
                                <h4>Tabla de recomendaciones</h4>
                                <p>Los datos se mostrarán aquí después de cargarse desde Excel.</p>
                            </div>
                            <div class="table-responsive" id="tableContainer" style="display: none;">
                                <table id="recommendationsTable" class="table table-hover table-striped">
                                    <thead>
                                        <tr>
                                            <th>Proyecto</th>
                                            <th>Año</th>
                                            <th>Riesgo</th>
                                            <th>Deficiencia</th>
                                            <th>Recomendación</th>
                                            <th>Estado</th>
                                            <th>Responsable</th>
                                            <th>Fecha Seguimiento</th>
                                            <th>Observación</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Los datos se cargarán mediante JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal para ver detalles -->
        <div class="modal fade" id="detailModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Detalle de Recomendación</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-6">
                                <p><strong>Proyecto:</strong> <span id="modal-project"></span></p>
                                <p><strong>Año:</strong> <span id="modal-year"></span></p>
                                <p><strong>Nivel de Riesgo:</strong> <span id="modal-risk"></span></p>
                            </div>
                            <div class="col-md-6">
                                <p><strong>Estado:</strong> <span id="modal-status"></span></p>
                                <p><strong>Responsable:</strong> <span id="modal-responsible"></span></p>
                                <p><strong>Fecha Seguimiento:</strong> <span id="modal-date"></span></p>
                            </div>
                        </div>
                        <hr>
                        <p><strong>Deficiencia:</strong></p>
                        <p id="modal-deficiency" class="bg-light p-3 rounded"></p>
                        <p><strong>Recomendación:</strong></p>
                        <p id="modal-recommendation" class="bg-light p-3 rounded"></p>
                        <p><strong>Observación:</strong></p>
                        <p id="modal-observation" class="bg-light p-3 rounded"></p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <footer class="bg-dark text-white mt-5 py-4">
            <div class="container">
                <div class="row">
                    <div class="col-md-6">
                        <h5>FIAS - Fiscalización Ambiental</h5>
                        <p>Sistema de seguimiento de recomendaciones de auditoría interna</p>
                    </div>
                    <div class="col-md-6 text-end">
                        <p class="mb-0">© 2023 FIAS. Todos los derechos reservados.</p>
                        <p>Versión 1.0.0</p>
                    </div>
                </div>
            </div>
        </footer>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.datatables.net/1.13.5/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.5/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    
    <!-- MSAL.js -->
    <script type="text/javascript" src="https://alcdn.msauth.net/browser/2.32.1/js/msal-browser.min.js"></script>
    
    <script>
        // Configuración de MSAL
        const msalConfig = {
            auth: {
               clientId: "deff0a8a-9d8b-4463-8d8f-382b82476757",
                authority: "https://login.microsoftonline.com/5e23e4af-237d-4d97-bf6e-dca808015787",
                redirectUri: window.location.origin
            },
            cache: {
                cacheLocation: "sessionStorage",
                storeAuthStateInCookie: false
            }
        };

        const msalInstance = new msal.PublicClientApplication(msalConfig);
        
        // Configuración de Excel
        const excelConfig = {
            fileId: "1abc2def3ghi4jkl5mno6pqr7stu8vwx9yz0abc1", // Reemplazar con File ID real
            worksheetName: "Base",
            redirectUri: window.location.origin
        };

        // Variables globales
        let recommendationsData = [];
        let statusChartInstance = null;
        let riskChartInstance = null;
        let dataTableInstance = null;

        // Mapeo de estados para evitar ambigüedades
        const statusMapping = {
            'Cumplido': 'Cumplido',
            'Cumplido Parcialmente': 'Cumplido Parcialmente',
            'No Cumplido': 'No Cumplido',
            'En Proceso': 'En Proceso',
            'Pendiente': 'Pendiente',
            'No se Implementará': 'No se Implementará',
            'No Aplica': 'No Aplica'
        };

        // Función para categorizar estados sin ambigüedad
        function categorizeStatus(statusText) {
            if (!statusText) return 'No definido';
            
            const status = statusText.trim();
            
            // Verificación exacta para evitar ambigüedades
            if (status === 'Cumplido') return statusMapping.Cumplido;
            if (status === 'Cumplido Parcialmente') return statusMapping['Cumplido Parcialmente'];
            if (status === 'No Cumplido') return statusMapping['No Cumplido'];
            if (status === 'En Proceso') return statusMapping['En Proceso'];
            if (status === 'Pendiente') return statusMapping.Pendiente;
            if (status === 'No se Implementará') return statusMapping['No se Implementará'];
            if (status === 'No Aplica') return statusMapping['No Aplica'];
            
            // Si no coincide exactamente, buscar por inclusión pero con verificaciones adicionales
            if (status.includes('Cumplido') && !status.includes('Parcialmente') && !status.includes('No')) return statusMapping.Cumplido;
            if (status.includes('Parcial')) return statusMapping['Cumplido Parcialmente'];
            if (status.includes('No') && status.includes('Cumplido')) return statusMapping['No Cumplido'];
            if (status.includes('Proceso')) return statusMapping['En Proceso'];
            if (status.includes('Pendiente')) return statusMapping.Pendiente;
            if (status.includes('Implementará')) return statusMapping['No se Implementará'];
            if (status.includes('Aplica')) return statusMapping['No Aplica'];
            
            return status; // Devolver el texto original si no coincide con ningún patrón
        }

        // Función para obtener el nombre de la clase CSS para el estado
        function getStatusClass(status) {
            const normalizedStatus = categorizeStatus(status);
            
            switch(normalizedStatus) {
                case 'Cumplido': return 'status-cumplido';
                case 'Cumplido Parcialmente': return 'status-cumplido-parcial';
                case 'No Cumplido': return 'status-no-cumplido';
                case 'En Proceso': return 'status-en-proceso';
                case 'Pendiente': return 'status-pendiente';
                case 'No se Implementará': return 'status-no-implementara';
                case 'No Aplica': return 'status-no-aplica';
                default: return 'status-pendiente';
            }
        }

        // Función para procesar datos y calcular estadísticas
        function processData(data) {
            const statusCount = {
                'Cumplido': 0,
                'Cumplido Parcialmente': 0,
                'No Cumplido': 0,
                'En Proceso': 0,
                'Pendiente': 0,
                'No se Implementará': 0,
                'No Aplica': 0,
                'No definido': 0
            };
            
            const riskCount = {
                'ALTO': 0,
                'MEDIO': 0,
                'BAJO': 0,
                'No definido': 0
            };
            
            const projects = new Set();
            const years = new Set();
            const statuses = new Set();
            
            // Procesar cada registro
            data.forEach(item => {
                // Categorizar estado sin ambigüedad
                const status = categorizeStatus(item.Estado || '');
                statusCount[status] = (statusCount[status] || 0) + 1;
                
                // Contar por nivel de riesgo
                const risk = item['Nivel de Riesgo'] || 'No definido';
                riskCount[risk] = (riskCount[risk] || 0) + 1;
                
                // Recopilar valores únicos para filtros
                if (item.Proyecto) projects.add(item.Proyecto);
                if (item.Año) years.add(item.Año);
                if (status) statuses.add(status);
            });
            
            return {
                statusCount,
                riskCount,
                projects: Array.from(projects).sort(),
                years: Array.from(years).sort((a, b) => b - a), // Ordenar años descendente
                statuses: Array.from(statuses).sort()
            };
        }

        // Función para actualizar los paneles del dashboard
        function updateDashboard(processedData) {
            const { statusCount, riskCount } = processedData;
            const total = Object.values(statusCount).reduce((sum, count) => sum + count, 0);
            
            // Calcular porcentajes correctamente
            const cumplidoPercent = total > 0 ? Math.round((statusCount['Cumplido'] / total) * 100) : 0;
            const parcialPercent = total > 0 ? Math.round((statusCount['Cumplido Parcialmente'] / total) * 100) : 0;
            const noCumplidoPercent = total > 0 ? Math.round((statusCount['No Cumplido'] / total) * 100) : 0;
            const enProcesoPercent = total > 0 ? Math.round((statusCount['En Proceso'] / total) * 100) : 0;
            
            // Actualizar HTML del dashboard
            document.getElementById('dashboardCards').innerHTML = `
                <div class="col-md-3 mb-3">
                    <div class="card dashboard-card">
                        <div class="card-body text-center">
                            <h6 class="card-title text-muted">Total Recomendaciones</h6>
                            <h2 class="text-primary">${total}</h2>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="card dashboard-card">
                        <div class="card-body">
                            <h6 class="card-title text-muted">Cumplidas</h6>
                            <h2 class="text-success">${statusCount['Cumplido']}</h2>
                            <div class="progress">
                                <div class="progress-bar bg-success" role="progressbar" style="width: ${cumplidoPercent}%"></div>
                            </div>
                            <small>${cumplidoPercent}% del total</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="card dashboard-card">
                        <div class="card-body">
                            <h6 class="card-title text-muted">Parcialmente Cumplidas</h6>
                            <h2 class="text-primary">${statusCount['Cumplido Parcialmente']}</h2>
                            <div class="progress">
                                <div class="progress-bar bg-primary" role="progressbar" style="width: ${parcialPercent}%"></div>
                            </div>
                            <small>${parcialPercent}% del total</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="card dashboard-card">
                        <div class="card-body">
                            <h6 class="card-title text-muted">No Cumplidas</h6>
                            <h2 class="text-danger">${statusCount['No Cumplido']}</h2>
                            <div class="progress">
                                <div class="progress-bar bg-danger" role="progressbar" style="width: ${noCumplidoPercent}%"></div>
                            </div>
                            <small>${noCumplidoPercent}% del total</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="card dashboard-card">
                        <div class="card-body text-center">
                            <h6 class="card-title text-muted">En Proceso</h6>
                            <h2 class="text-warning">${statusCount['En Proceso']}</h2>
                            <div class="progress">
                                <div class="progress-bar bg-warning" role="progressbar" style="width: ${enProcesoPercent}%"></div>
                            </div>
                            <small>${enProcesoPercent}% del total</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="card dashboard-card">
                        <div class="card-body text-center">
                            <h6 class="card-title text-muted">Alto Riesgo</h6>
                            <h2 class="text-danger">${riskCount['ALTO']}</h2>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="card dashboard-card">
                        <div class="card-body text-center">
                            <h6 class="card-title text-muted">Medio Riesgo</h6>
                            <h2 class="text-warning">${riskCount['MEDIO']}</h2>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="card dashboard-card">
                        <div class="card-body text-center">
                            <h6 class="card-title text-muted">Bajo Riesgo</h6>
                            <h2 class="text-success">${riskCount['BAJO']}</h2>
                        </div>
                    </div>
                </div>
            `;
        }

        // Función para actualizar gráficos
        function updateCharts(processedData) {
            const { statusCount, riskCount } = processedData;
            
            // Destruir instancias anteriores si existen
            if (statusChartInstance) {
                statusChartInstance.destroy();
            }
            if (riskChartInstance) {
                riskChartInstance.destroy();
            }
            
            // Colores para los gráficos
            const statusColors = {
                'Cumplido': '#28a745',
                'Cumplido Parcialmente': '#17a2b8',
                'No Cumplido': '#dc3545',
                'En Proceso': '#ffc107',
                'Pendiente': '#6c757d',
                'No se Implementará': '#343a40',
                'No Aplica': '#adb5bd',
                'No definido': '#e9ecef'
            };
            
            const riskColors = {
                'ALTO': '#dc3545',
                'MEDIO': '#ffc107',
                'BAJO': '#28a745',
                'No definido': '#6c757d'
            };
            
            // Gráfico de estados
            const statusCtx = document.getElementById('statusChart').getContext('2d');
            statusChartInstance = new Chart(statusCtx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(statusCount).filter(key => statusCount[key] > 0),
                    datasets: [{
                        data: Object.keys(statusCount).filter(key => statusCount[key] > 0).map(key => statusCount[key]),
                        backgroundColor: Object.keys(statusCount).filter(key => statusCount[key] > 0).map(key => statusColors[key] || '#6c757d'),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.raw || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = Math.round((value / total) * 100);
                                    return `${label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
            
            // Gráfico de riesgos
            const riskCtx = document.getElementById('riskChart').getContext('2d');
            riskChartInstance = new Chart(riskCtx, {
                type: 'pie',
                data: {
                    labels: Object.keys(riskCount).filter(key => riskCount[key] > 0),
                    datasets: [{
                        data: Object.keys(riskCount).filter(key => riskCount[key] > 0).map(key => riskCount[key]),
                        backgroundColor: Object.keys(riskCount).filter(key => riskCount[key] > 0).map(key => riskColors[key] || '#6c757d'),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.raw || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = Math.round((value / total) * 100);
                                    return `${label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Función para poblar los filtros
        function populateFilters(processedData) {
            const { projects, years, statuses } = processedData;
            
            // Llenar filtro de proyectos
            const projectFilter = document.getElementById('projectFilter');
            projectFilter.innerHTML = '<option value="">Todos los proyectos</option>';
            projects.forEach(project => {
                projectFilter.innerHTML += `<option value="${project}">${project}</option>`;
            });
            
            // Llenar filtro de años
            const yearFilter = document.getElementById('yearFilter');
            yearFilter.innerHTML = '<option value="">Todos los años</option>';
            years.forEach(year => {
                yearFilter.innerHTML += `<option value="${year}">${year}</option>`;
            });
            
            // Llenar filtro de estados
            const statusFilter = document.getElementById('statusFilter');
            statusFilter.innerHTML = '<option value="">Todos los estados</option>';
            statuses.forEach(status => {
                statusFilter.innerHTML += `<option value="${status}">${status}</option>`;
            });
        }

        // Función para mostrar datos en la tabla
        function populateTable(data) {
            const tableBody = document.querySelector('#recommendationsTable tbody');
            tableBody.innerHTML = '';
            
            data.forEach(item => {
                const statusClass = getStatusClass(item.Estado || '');
                const riskLevel = item['Nivel de Riesgo'] || 'No definido';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${item.Proyecto || ''}</td>
                    <td>${item.Año || ''}</td>
                    <td><span class="badge ${riskLevel === 'ALTO' ? 'bg-danger' : riskLevel === 'MEDIO' ? 'bg-warning' : 'bg-success'}">${riskLevel}</span></td>
                    <td>${item.Deficiencia || ''}</td>
                    <td>${item.Recomendación || ''}</td>
                    <td><span class="status-badge ${statusClass}">${categorizeStatus(item.Estado || '')}</span></td>
                    <td>${item.Responsable || ''}</td>
                    <td>${item['Fecha Seguimiento'] || ''}</td>
                    <td>${item.Observación || ''}</td>
                `;
                
                // Agregar evento para mostrar detalles
                row.addEventListener('click', () => {
                    document.getElementById('modal-project').textContent = item.Proyecto || '';
                    document.getElementById('modal-year').textContent = item.Año || '';
                    document.getElementById('modal-risk').textContent = riskLevel;
                    document.getElementById('modal-status').innerHTML = `<span class="status-badge ${statusClass}">${categorizeStatus(item.Estado || '')}</span>`;
                    document.getElementById('modal-responsible').textContent = item.Responsable || '';
                    document.getElementById('modal-date').textContent = item['Fecha Seguimiento'] || '';
                    document.getElementById('modal-deficiency').textContent = item.Deficiencia || '';
                    document.getElementById('modal-recommendation').textContent = item.Recomendación || '';
                    document.getElementById('modal-observation').textContent = item.Observación || '';
                    
                    const modal = new bootstrap.Modal(document.getElementById('detailModal'));
                    modal.show();
                });
                
                tableBody.appendChild(row);
            });
            
            // Inicializar o actualizar DataTable
            if (dataTableInstance) {
                dataTableInstance.destroy();
            }
            
            dataTableInstance = $('#recommendationsTable').DataTable({
                language: {
                    url: '//cdn.datatables.net/plug-ins/1.13.5/i18n/es-ES.json'
                },
                pageLength: 10,
                lengthMenu: [5, 10, 25, 50],
                order: [[1, 'desc']] // Ordenar por año descendente por defecto
            });
            
            // Mostrar la tabla
            document.querySelector('.no-data-message').style.display = 'none';
            document.getElementById('tableContainer').style.display = 'block';
        }

        // Función para aplicar filtros
        function applyFilters() {
            const projectValue = document.getElementById('projectFilter').value;
            const yearValue = document.getElementById('yearFilter').value;
            const statusValue = document.getElementById('statusFilter').value;
            const riskValue = document.getElementById('riskFilter').value;
            
            const filteredData = recommendationsData.filter(item => {
                const projectMatch = !projectValue || item.Proyecto === projectValue;
                const yearMatch = !yearValue || item.Año == yearValue;
                const statusMatch = !statusValue || categorizeStatus(item.Estado || '') === statusValue;
                const riskMatch = !riskValue || item['Nivel de Riesgo'] === riskValue;
                
                return projectMatch && yearMatch && statusMatch && riskMatch;
            });
            
            // Procesar datos filtrados
            const processedData = processData(filteredData);
            
            // Actualizar dashboard y gráficos con datos filtrados
            updateDashboard(processedData);
            updateCharts(processedData);
            populateTable(filteredData);
        }

        // Función para cargar datos desde Excel Online
        async function loadDataFromExcel() {
            try {
                showLoading("Conectando con Excel Online...");
                
                // Verificar si estamos autenticados
                const accounts = msalInstance.getAllAccounts();
                if (accounts.length === 0) {
                    hideLoading();
                    showAuthUI();
                    return;
                }
                
                // Obtener token de acceso
                const accessTokenRequest = {
                    scopes: ["https://graph.microsoft.com/.default"],
                    account: accounts[0]
                };
                
                const response = await msalInstance.acquireTokenSilent(accessTokenRequest);
                const accessToken = response.accessToken;
                
                showLoading("Descargando datos desde Excel Online...");
                
                // Obtener datos de Excel
                const excelResponse = await fetch(`https://graph.microsoft.com/v1.0/me/drive/items/${excelConfig.fileId}/workbook/worksheets/${excelConfig.worksheetName}/usedRange`, {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });
                
                if (!excelResponse.ok) {
                    throw new Error(`Error al obtener datos de Excel: ${excelResponse.statusText}`);
                }
                
                const excelData = await excelResponse.json();
                
                // Convertir datos de Excel a formato JSON
                const values = excelData.values;
                if (!values || values.length < 2) {
                    throw new Error("No se encontraron datos en la hoja de Excel");
                }
                
                // Obtener encabezados (primera fila)
                const headers = values[0];
                
                // Crear array de objetos
                const jsonData = [];
                for (let i = 1; i < values.length; i++) {
                    const row = values[i];
                    const rowData = {};
                    
                    for (let j = 0; j < headers.length; j++) {
                        rowData[headers[j]] = row[j] || '';
                    }
                    
                    jsonData.push(rowData);
                }
                
                recommendationsData = jsonData;
                
                // Procesar datos
                const processedData = processData(recommendationsData);
                
                // Actualizar UI
                updateDashboard(processedData);
                updateCharts(processedData);
                populateFilters(processedData);
                populateTable(recommendationsData);
                
                // Configurar event listeners para filtros
                document.getElementById('projectFilter').addEventListener('change', applyFilters);
                document.getElementById('yearFilter').addEventListener('change', applyFilters);
                document.getElementById('statusFilter').addEventListener('change', applyFilters);
                document.getElementById('riskFilter').addEventListener('change', applyFilters);
                
                hideLoading();
                showMainUI();
                
            } catch (error) {
                console.error("Error al cargar datos:", error);
                hideLoading();
                
                if (error instanceof msal.InteractionRequiredAuthError) {
                    showAuthUI();
                } else {
                    alert("Error al cargar datos: " + error.message);
                }
            }
        }

        // Funciones para manejar la UI
        function showLoading(message = "Cargando...") {
            document.getElementById('loadingText').textContent = message;
            document.getElementById('loadingOverlay').style.display = 'flex';
        }
        
        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }
        
        function showAuthUI() {
            document.getElementById('authContainer').style.display = 'block';
            document.getElementById('mainContent').style.display = 'none';
            document.getElementById('configContainer').style.display = 'none';
        }
        
        function showMainUI() {
            document.getElementById('authContainer').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';
            document.getElementById('configContainer').style.display = 'none';
        }
        
        function showConfigUI() {
            document.getElementById('authContainer').style.display = 'none';
            document.getElementById('mainContent').style.display = 'none';
            document.getElementById('configContainer').style.display = 'block';
        }

        // Inicializar la aplicación
        async function initializeApp() {
            try {
                // Verificar la configuración de redirectUri
                if (window.location.origin === "null" || 
                    window.location.origin === "http://localhost:8000" || 
                    window.location.origin === "https://jaircruz1304.github.io") {
                    
                    await msalInstance.initialize();
                    
                    // Manejar la respuesta de redirección
                    const response = await msalInstance.handleRedirectPromise();
                    if (response) {
                        // Usuario autenticado, cargar datos
                        loadDataFromExcel();
                    } else {
                        // Verificar si ya está autenticado
                        const accounts = msalInstance.getAllAccounts();
                        if (accounts.length > 0) {
                            // Ya autenticado, cargar datos
                            loadDataFromExcel();
                        } else {
                            // No autenticado, mostrar UI de autenticación
                            hideLoading();
                            showAuthUI();
                        }
                    }
                } else {
                    // Redirect URI no configurado correctamente
                    hideLoading();
                    showConfigUI();
                }
            } catch (error) {
                console.error("Error inicializando la aplicación:", error);
                hideLoading();
                alert("Error inicializando la aplicación: " + error.message);
            }
        }

        // Event Listeners
        document.getElementById('loginBtn').addEventListener('click', () => {
            msalInstance.loginRedirect({
                scopes: ["https://graph.microsoft.com/.default"]
            });
        });
        
        document.getElementById('logoutBtn').addEventListener('click', () => {
            msalInstance.logoutRedirect();
        });
        
        document.getElementById('refreshData').addEventListener('click', () => {
            loadDataFromExcel();
        });
        
        document.getElementById('exportBtn').addEventListener('click', () => {
            // Implementar funcionalidad de exportación
            alert("Funcionalidad de exportación en desarrollo");
        });

        // Iniciar la aplicación cuando el DOM esté listo
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>
