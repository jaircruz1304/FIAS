<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Seguimiento de Recomendaciones - FIAS</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- DataTables CSS -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.5/css/dataTables.bootstrap5.min.css">
    <style>
        :root {
            --fias-primary: #2c7d32;
            --fias-secondary: #8bc34a;
            --fias-accent: #ffc107;
        }
        
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .navbar {
            background-color: var(--fias-primary);
        }
        
        .card-header {
            background-color: var(--fias-primary);
            color: white;
        }
        
        .status-badge {
            padding: 0.5em 1em;
            border-radius: 20px;
            font-weight: 600;
        }
        
        .status-en-proceso {
            background-color: #fff3cd;
            color: #856404;
        }
        
        .status-cumplido {
            background-color: #d4edda;
            color: #155724;
        }
        
        .status-no-cumplido {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        .status-pendiente {
            background-color: #cce5ff;
            color: #004085;
        }
        
        .status-no-aplica {
            background-color: #e2e3e5;
            color: #383d41;
        }
        
        .risk-high {
            border-left: 5px solid #dc3545;
        }
        
        .risk-medium {
            border-left: 5px solid #ffc107;
        }
        
        .risk-low {
            border-left: 5px solid #28a745;
        }
        
        .dashboard-card {
            transition: transform 0.3s;
            border: none;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .dashboard-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }
        
        .chart-container {
            position: relative;
            height: 250px;
        }
        
        .progress {
            height: 10px;
        }
        
        .filter-section {
            background-color: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        
        .logo-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .logo-icon {
            font-size: 24px;
            color: white;
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .spinner-border {
            width: 3rem;
            height: 3rem;
        }
        
        .auth-container {
            max-width: 500px;
            margin: 50px auto;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .config-help {
            background-color: #f8f9fa;
            border-left: 4px solid #0d6efd;
            padding: 15px;
            margin-top: 20px;
        }
        
        .no-data-message {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }
        
        .permission-help {
            background-color: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="text-center">
            <div class="spinner-border text-success" role="status">
                <span class="visually-hidden">Cargando...</span>
            </div>
            <p class="mt-3" id="loadingText">Conectando con Excel Online...</p>
        </div>
    </div>

    <!-- Contenedor de configuración para desarrollo -->
    <div id="configContainer" class="auth-container" style="display: none;">
        <div class="text-center mb-4">
            <i class="fas fa-cogs fa-3x text-primary"></i>
            <h3 class="mt-2">Configuración Requerida</h3>
            <p>Para que la aplicación funcione correctamente, necesita configurar el Redirect URI en Azure AD.</p>
        </div>
        
        <div class="config-help">
            <h5>Pasos para configurar Azure AD:</h5>
            <ol>
                <li>Inicie sesión en <a href="https://portal.azure.com/" target="_blank">Azure Portal</a></li>
                <li>Vaya a <strong>Azure Active Directory</strong> > <strong>Registros de aplicaciones</strong></li>
                <li>Seleccione su aplicación <strong>"Auditoria - Recomendaciones"</strong></li>
                <li>Vaya a la sección <strong>"Autenticación"</strong></li>
                <li>Agregue estos Redirect URIs:
                    <ul>
                        <li><code>https://jaircruz1304.github.io</code></li>
                        <li><code>http://localhost:8000</code> (para desarrollo)</li>
                    </ul>
                </li>
                <li>Guarde los cambios</li>
            </ol>
            <p class="mb-0">Después de configurar, <button class="btn btn-sm btn-success" onclick="location.reload()">recargue la página</button></p>
        </div>
        
        <div class="mt-3">
            <button class="btn btn-primary w-100" onclick="window.open('https://portal.azure.com/', '_blank')">
                <i class="fas fa-external-link-alt me-2"></i> Abrir Azure Portal
            </button>
        </div>
    </div>

    <!-- Contenedor de permisos -->
    <div id="permissionContainer" class="auth-container" style="display: none;">
        <div class="text-center mb-4">
            <i class="fas fa-lock fa-3x text-warning"></i>
            <h3 class="mt-2">Permisos Insuficientes</h3>
            <p>Su cuenta no tiene permisos para acceder al archivo Excel. Contacte al administrador.</p>
        </div>
        
        <div class="permission-help">
            <h5>Para otorgar acceso:</h5>
            <ol>
                <li>Abra el archivo en SharePoint Online</li>
                <li>Haga clic en "Compartir" en la esquina superior derecha</li>
                <li>Seleccione "Cualquier persona con el vínculo" o agregue usuarios específicos</li>
                <li>Asegúrese de otorgar permisos de "Lectura" como mínimo</li>
            </ol>
        </div>
        
        <div class="mt-3">
            <button class="btn btn-primary w-100" onclick="location.reload()">
                <i class="fas fa-sync-alt me-2"></i> Reintentar
            </button>
        </div>
    </div>

    <!-- Contenedor de autenticación (inicialmente oculto) -->
    <div id="authContainer" class="auth-container" style="display: none;">
        <div class="text-center mb-4">
            <i class="fas fa-leaf fa-3x text-success"></i>
            <h3 class="mt-2">Autenticación requerida</h3>
            <p>Para acceder a los datos del Excel, necesita autenticarse con su cuenta de Office 365.</p>
        </div>
        <button id="loginBtn" class="btn btn-success w-100">
            <i class="fas fa-sign-in-alt me-2"></i> Iniciar sesión con Microsoft
        </button>
        <div class="mt-3 text-center">
            <small class="text-muted">Utilice su cuenta corporativa de FIAS</small>
        </div>
    </div>

    <!-- Contenido principal (inicialmente oculto) -->
    <div id="mainContent" style="display: none;">
        <!-- Navbar -->
        <nav class="navbar navbar-expand-lg navbar-dark">
            <div class="container">
                <div class="logo-container">
                    <i class="fas fa-leaf logo-icon"></i>
                    <a class="navbar-brand" href="#">FIAS - Seguimiento de Recomendaciones</a>
                </div>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav ms-auto">
                        <li class="nav-item">
                            <a class="nav-link active" href="#"><i class="fas fa-home me-1"></i> Inicio</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#"><i class="fas fa-chart-bar me-1"></i> Dashboard</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#"><i class="fas fa-list me-1"></i> Recomendaciones</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#"><i class="fas fa-user me-1"></i> Auditoría Interna</a>
                        </li>
                        <li class="nav-item">
                            <button class="btn btn-outline-light btn-sm mt-1" id="refreshData">
                                <i class="fas fa-sync-alt me-1"></i> Actualizar
                            </button>
                        </li>
                        <li class="nav-item">
                            <button class="btn btn-outline-light btn-sm mt-1 ms-2" id="logoutBtn">
                                <i class="fas fa-sign-out-alt me-1"></i> Cerrar sesión
                            </button>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>

        <div class="container mt-4">
            <!-- Filtros -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="filter-section">
                        <div class="row">
                            <div class="col-md-3 mb-2">
                                <label for="projectFilter" class="form-label">Proyecto</label>
                                <select class="form-select" id="projectFilter">
                                    <option value="">Todos los proyectos</option>
                                    <!-- Se llenará dinámicamente -->
                                </select>
                            </div>
                            <div class="col-md-3 mb-2">
                                <label for="yearFilter" class="form-label">Año</label>
                                <select class="form-select" id="yearFilter">
                                    <option value="">Todos los años</option>
                                    <!-- Se llenará dinámicamente -->
                                </select>
                            </div>
                            <div class="col-md-3 mb-2">
                                <label for="statusFilter" class="form-label">Estado</label>
                                <select class="form-select" id="statusFilter">
                                    <option value="">Todos los estados</option>
                                    <!-- Se llenará dinámicamente -->
                                </select>
                            </div>
                            <div class="col-md-3 mb-2">
                                <label for="riskFilter" class="form-label">Nivel de Riesgo</label>
                                <select class="form-select" id="riskFilter">
                                    <option value="">Todos los niveles</option>
                                    <option value="ALTO">ALTO</option>
                                    <option value="MEDIO">MEDIO</option>
                                    <option value="BAJO">BAJO</option>
                                </select>
                            </div>
                        </div>
                        <div class="row mt-2">
                            <div class="col-12 text-end">
                                <button class="btn btn-sm btn-outline-secondary" id="clearFilters">
                                    <i class="fas fa-times me-1"></i> Limpiar filtros
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Dashboard Cards -->
            <div class="row mb-4" id="dashboardCards">
                <div class="col-12">
                    <div class="no-data-message">
                        <i class="fas fa-database fa-3x mb-3"></i>
                        <h4>Esperando datos de Excel</h4>
                        <p>Los datos se cargarán automáticamente después de la autenticación.</p>
                    </div>
                </div>
            </div>

            <!-- Charts -->
            <div class="row mb-4">
                <div class="col-md-6 mb-3">
                    <div class="card dashboard-card">
                        <div class="card-header">
                            <h5 class="mb-0">Recomendaciones por Estado</h5>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="statusChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6 mb-3">
                    <div class="card dashboard-card">
                        <div class="card-header">
                            <h5 class="mb-0">Recomendaciones por Nivel de Riesgo</h5>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="riskChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tabla de Recomendaciones -->
            <div class="row">
                <div class="col-12">
                    <div class="card dashboard-card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">Lista de Recomendaciones</h5>
                            <div>
                                <button class="btn btn-sm btn-outline-light" id="exportBtn">
                                    <i class="fas fa-download me-1"></i> Exportar
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="no-data-message">
                                <i class="fas fa-table fa-3x mb-3"></i>
                                <h4>Tabla de recomendaciones</h4>
                                <p>Los datos se mostrarán aquí después de cargarse desde Excel.</p>
                            </div>
                            <div class="table-responsive" id="tableContainer" style="display: none;">
                                <table id="recommendationsTable" class="table table-hover table-striped">
                                    <thead>
                                        <tr>
                                            <th>Proyecto</th>
                                            <th>Año</th>
                                            <th>Riesgo</th>
                                            <th>Deficiencia</th>
                                            <th>Recomendación</th>
                                            <th>Estado</th>
                                            <th>Responsable</th>
                                            <th>Fecha Seguimiento</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Los datos se cargarán mediante JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal para ver detalles -->
        <div class="modal fade" id="detailModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Detalles de Recomendación</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body" id="modalBody">
                        <!-- Contenido dinámico -->
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    </div>
                </div>
            </div>
        </div>

        <footer class="mt-5 py-3 bg-light">
            <div class="container text-center">
                <p class="mb-0">FIAS - Fiscalización Ambiental | Sistema de Seguimiento de Recomendaciones</p>
                <small class="text-muted">© 2023 Auditoría Interna FIAS</small>
            </div>
        </footer>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- DataTables JS -->
    <script src="https://cdn.datatables.net/1.13.5/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.5/js/dataTables.bootstrap5.min.js"></script>
    <!-- MSAL.js -->
    <script src="https://alcdn.msauth.net/browser/2.32.1/js/msal-browser.min.js"></script>
    <!-- ExcelJS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.4.0/exceljs.min.js"></script>

    <script>
        // Configuración de MSAL
        const msalConfig = {
            auth: {
                clientId: "deff0a8a-9d8b-4463-8d8f-382b82476757", // Reemplazar con el Client ID real
                authority: "https://login.microsoftonline.com/5e23e4af-237d-4d97-bf6e-dca808015787",
                redirectUri: window.location.origin
            },
            cache: {
                cacheLocation: "sessionStorage",
                storeAuthStateInCookie: false
            }
        };

        // Permisos requeridos
        const loginRequest = {
            scopes: ["User.Read", "Files.Read", "Files.Read.All", "Sites.Read.All"]
        };

        // Inicializar aplicación MSAL
        const msalInstance = new msal.PublicClientApplication(msalConfig);

        // Variables globales para almacenar datos y gráficos
        let allRecommendations = [];
        let filteredRecommendations = [];
        let statusChartInstance = null;
        let riskChartInstance = null;
        let dataTableInstance = null;

        // Elementos DOM
        const loadingOverlay = document.getElementById('loadingOverlay');
        const loadingText = document.getElementById('loadingText');
        const authContainer = document.getElementById('authContainer');
        const mainContent = document.getElementById('mainContent');
        const configContainer = document.getElementById('configContainer');
        const permissionContainer = document.getElementById('permissionContainer');
        const loginBtn = document.getElementById('loginBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const refreshDataBtn = document.getElementById('refreshData');
        const clearFiltersBtn = document.getElementById('clearFilters');
        const exportBtn = document.getElementById('exportBtn');

        // Filtros
        const projectFilter = document.getElementById('projectFilter');
        const yearFilter = document.getElementById('yearFilter');
        const statusFilter = document.getElementById('statusFilter');
        const riskFilter = document.getElementById('riskFilter');

        // Función para manejar el inicio de sesión
        async function handleLogin() {
            try {
                loadingText.textContent = "Iniciando sesión...";
                loadingOverlay.style.display = 'flex';
                
                await msalInstance.loginPopup(loginRequest);
                const accounts = msalInstance.getAllAccounts();
                
                if (accounts.length > 0) {
                    await loadExcelData();
                } else {
                    showAuthUI();
                }
            } catch (error) {
                console.error("Error durante el inicio de sesión:", error);
                loadingOverlay.style.display = 'none';
                alert("Error durante el inicio de sesión: " + error.message);
            }
        }

        // Función para manejar el cierre de sesión
        function handleLogout() {
            msalInstance.logoutPopup({
                postLogoutRedirectUri: window.location.origin,
                mainWindowRedirectUri: window.location.origin
            });
        }

        // Función para mostrar la interfaz de autenticación
        function showAuthUI() {
            authContainer.style.display = 'block';
            mainContent.style.display = 'none';
            configContainer.style.display = 'none';
            permissionContainer.style.display = 'none';
            loadingOverlay.style.display = 'none';
        }

        // Función para mostrar el contenido principal
        function showMainUI() {
            authContainer.style.display = 'none';
            mainContent.style.display = 'block';
            configContainer.style.display = 'none';
            permissionContainer.style.display = 'none';
            loadingOverlay.style.display = 'none';
        }

        // Función para mostrar el contenedor de configuración
        function showConfigUI() {
            authContainer.style.display = 'none';
            mainContent.style.display = 'none';
            configContainer.style.display = 'block';
            permissionContainer.style.display = 'none';
            loadingOverlay.style.display = 'none';
        }

        // Función para mostrar el contenedor de permisos
        function showPermissionUI() {
            authContainer.style.display = 'none';
            mainContent.style.display = 'none';
            configContainer.style.display = 'none';
            permissionContainer.style.display = 'block';
            loadingOverlay.style.display = 'none';
        }

        // Función para cargar datos de Excel
        async function loadExcelData() {
            try {
                loadingText.textContent = "Cargando datos desde Excel...";
                loadingOverlay.style.display = 'flex';
                
                const accounts = msalInstance.getAllAccounts();
                if (accounts.length === 0) {
                    throw new Error("No hay cuentas autenticadas");
                }

                // Obtener token de acceso
                const tokenResponse = await msalInstance.acquireTokenSilent({
                    ...loginRequest,
                    account: accounts[0]
                });

                // URL del archivo Excel (reemplazar con la URL real)
                const excelFileUrl = "https://graph.microsoft.com/v1.0/me/drive/items/ITEM_ID/workbook/worksheets/Sheet1/usedRange";
                // Alternativa para SharePoint: /sites/{site-id}/drive/items/{item-id}/workbook/worksheets/Sheet1/usedRange
                
                // Simulación de carga de datos (reemplazar con llamada real a Graph API)
                setTimeout(() => {
                    // Datos de ejemplo (simulados)
                    allRecommendations = generateSampleData();
                    filteredRecommendations = [...allRecommendations];
                    
                    // Inicializar la interfaz con los datos
                    initializeUIWithData();
                    
                    // Ocultar overlay y mostrar contenido principal
                    loadingOverlay.style.display = 'none';
                    showMainUI();
                }, 2000);
                
            } catch (error) {
                console.error("Error cargando datos de Excel:", error);
                
                if (error.errorCode === "invalid_client") {
                    showConfigUI();
                } else if (error.errorCode === "access_denied" || error.message.includes("permisos")) {
                    showPermissionUI();
                } else {
                    loadingOverlay.style.display = 'none';
                    alert("Error cargando datos: " + error.message);
                    showAuthUI();
                }
            }
        }

        // Función para inicializar la interfaz con datos
        function initializeUIWithData() {
            // Actualizar filtros
            updateFilterOptions();
            
            // Actualizar dashboard
            updateDashboardCards();
            
            // Inicializar gráficos
            initializeCharts();
            
            // Inicializar tabla
            initializeDataTable();
            
            // Aplicar filtros iniciales
            applyFilters();
        }

        // Función para actualizar las opciones de los filtros
        function updateFilterOptions() {
            // Proyectos
            const projects = [...new Set(allRecommendations.map(item => item.proyecto))].sort();
            projectFilter.innerHTML = '<option value="">Todos los proyectos</option>';
            projects.forEach(project => {
                projectFilter.innerHTML += `<option value="${project}">${project}</option>`;
            });
            
            // Años
            const years = [...new Set(allRecommendations.map(item => item.año))].sort((a, b) => b - a);
            yearFilter.innerHTML = '<option value="">Todos los años</option>';
            years.forEach(year => {
                yearFilter.innerHTML += `<option value="${year}">${year}</option>`;
            });
            
            // Estados
            const statuses = [...new Set(allRecommendations.map(item => item.estado))].sort();
            statusFilter.innerHTML = '<option value="">Todos los estados</option>';
            statuses.forEach(status => {
                statusFilter.innerHTML += `<option value="${status}">${status}</option>`;
            });
        }

        // Función para actualizar las tarjetas del dashboard
        function updateDashboardCards() {
            const total = filteredRecommendations.length;
            const cumplidas = filteredRecommendations.filter(item => item.estado === "CUMPLIDO").length;
            const enProceso = filteredRecommendations.filter(item => item.estado === "EN PROCESO").length;
            const noCumplidas = filteredRecommendations.filter(item => item.estado === "NO CUMPLIDO").length;
            const pendientes = filteredRecommendations.filter(item => item.estado === "PENDIENTE").length;
            
            const cumplimientoPorcentaje = total > 0 ? Math.round((cumplidas / total) * 100) : 0;
            
            document.getElementById('dashboardCards').innerHTML = `
                <div class="col-md-2 col-6 mb-3">
                    <div class="card dashboard-card">
                        <div class="card-body text-center">
                            <h6 class="card-subtitle mb-1 text-muted">Total</h6>
                            <h3 class="card-title text-primary">${total}</h3>
                            <p class="card-text small">Recomendaciones</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-2 col-6 mb-3">
                    <div class="card dashboard-card">
                        <div class="card-body text-center">
                            <h6 class="card-subtitle mb-1 text-muted">Cumplidas</h6>
                            <h3 class="card-title text-success">${cumplidas}</h3>
                            <div class="progress mt-2">
                                <div class="progress-bar bg-success" role="progressbar" style="width: ${cumplimientoPorcentaje}%"></div>
                            </div>
                            <p class="card-text small mt-1">${cumplimientoPorcentaje}% de cumplimiento</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-2 col-6 mb-3">
                    <div class="card dashboard-card">
                        <div class="card-body text-center">
                            <h6 class="card-subtitle mb-1 text-muted">En Proceso</h6>
                            <h3 class="card-title text-warning">${enProceso}</h3>
                            <p class="card-text small">En implementación</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-2 col-6 mb-3">
                    <div class="card dashboard-card">
                        <div class="card-body text-center">
                            <h6 class="card-subtitle mb-1 text-muted">No Cumplidas</h6>
                            <h3 class="card-title text-danger">${noCumplidas}</h3>
                            <p class="card-text small">Por atender</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-2 col-6 mb-3">
                    <div class="card dashboard-card">
                        <div class="card-body text-center">
                            <h6 class="card-subtitle mb-1 text-muted">Pendientes</h6>
                            <h3 class="card-title text-info">${pendientes}</h3>
                            <p class="card-text small">Por revisar</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-2 col-6 mb-3">
                    <div class="card dashboard-card">
                        <div class="card-body text-center">
                            <h6 class="card-subtitle mb-1 text-muted">Cumplimiento</h6>
                            <h3 class="card-title">${cumplimientoPorcentaje}%</h3>
                            <p class="card-text small">Global</p>
                        </div>
                    </div>
                </div>
            `;
        }

        // Función para inicializar gráficos
        function initializeCharts() {
            const statusCtx = document.getElementById('statusChart').getContext('2d');
            const riskCtx = document.getElementById('riskChart').getContext('2d');
            
            // Destruir gráficos existentes si los hay
            if (statusChartInstance) {
                statusChartInstance.destroy();
            }
            if (riskChartInstance) {
                riskChartInstance.destroy();
            }
            
            // Datos para gráfico de estados
            const statusCounts = {};
            filteredRecommendations.forEach(item => {
                statusCounts[item.estado] = (statusCounts[item.estado] || 0) + 1;
            });
            
            // Datos para gráfico de niveles de riesgo
            const riskCounts = {};
            filteredRecommendations.forEach(item => {
                riskCounts[item.riesgo] = (riskCounts[item.riesgo] || 0) + 1;
            });
            
            // Colores para los gráficos
            const statusColors = {
                'CUMPLIDO': '#28a745',
                'EN PROCESO': '#ffc107',
                'NO CUMPLIDO': '#dc3545',
                'PENDIENTE': '#17a2b8',
                'NO APLICA': '#6c757d'
            };
            
            const riskColors = {
                'ALTO': '#dc3545',
                'MEDIO': '#ffc107',
                'BAJO': '#28a745'
            };
            
            // Crear gráfico de estados
            statusChartInstance = new Chart(statusCtx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(statusCounts),
                    datasets: [{
                        data: Object.values(statusCounts),
                        backgroundColor: Object.keys(statusCounts).map(status => statusColors[status] || '#6c757d'),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.raw || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = Math.round((value / total) * 100);
                                    return `${label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
            
            // Crear gráfico de niveles de riesgo
            riskChartInstance = new Chart(riskCtx, {
                type: 'bar',
                data: {
                    labels: Object.keys(riskCounts),
                    datasets: [{
                        label: 'Recomendaciones por Nivel de Riesgo',
                        data: Object.values(riskCounts),
                        backgroundColor: Object.keys(riskCounts).map(risk => riskColors[risk] || '#6c757d'),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        // Función para inicializar la tabla de datos
        function initializeDataTable() {
            const tableBody = document.querySelector('#recommendationsTable tbody');
            tableBody.innerHTML = '';
            
            filteredRecommendations.forEach(item => {
                const row = document.createElement('tr');
                row.classList.add(`risk-${item.riesgo.toLowerCase()}`);
                row.innerHTML = `
                    <td>${item.proyecto}</td>
                    <td>${item.año}</td>
                    <td><span class="badge bg-${getRiskBadgeClass(item.riesgo)}">${item.riesgo}</span></td>
                    <td>${item.deficiencia}</td>
                    <td>${item.recomendacion}</td>
                    <td><span class="status-badge status-${getStatusClass(item.estado)}">${item.estado}</span></td>
                    <td>${item.responsable}</td>
                    <td>${item.fechaSeguimiento}</td>
                `;
                
                // Agregar evento para mostrar detalles
                row.addEventListener('click', () => {
                    showDetailModal(item);
                });
                
                tableBody.appendChild(row);
            });
            
            // Destruir DataTable existente si hay uno
            if ($.fn.DataTable.isDataTable('#recommendationsTable')) {
                dataTableInstance.destroy();
            }
            
            // Inicializar DataTable
            dataTableInstance = $('#recommendationsTable').DataTable({
                language: {
                    url: '//cdn.datatables.net/plug-ins/1.13.5/i18n/es-ES.json'
                },
                pageLength: 10,
                lengthMenu: [5, 10, 25, 50],
                dom: '<"row"<"col-sm-12 col-md-6"l><"col-sm-12 col-md-6"f>>rt<"row"<"col-sm-12 col-md-6"i><"col-sm-12 col-md-6"p>>',
                initComplete: function() {
                    // Mostrar la tabla y ocultar el mensaje de "no data"
                    document.getElementById('tableContainer').style.display = 'block';
                    document.querySelectorAll('.no-data-message').forEach(el => {
                        el.style.display = 'none';
                    });
                }
            });
        }

        // Función para mostrar el modal de detalles
        function showDetailModal(item) {
            const modalBody = document.getElementById('modalBody');
            modalBody.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Proyecto:</strong> ${item.proyecto}</p>
                        <p><strong>Año:</strong> ${item.año}</p>
                        <p><strong>Nivel de Riesgo:</strong> <span class="badge bg-${getRiskBadgeClass(item.riesgo)}">${item.riesgo}</span></p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Estado:</strong> <span class="status-badge status-${getStatusClass(item.estado)}">${item.estado}</span></p>
                        <p><strong>Responsable:</strong> ${item.responsable}</p>
                        <p><strong>Fecha de Seguimiento:</strong> ${item.fechaSeguimiento}</p>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <p><strong>Deficiencia:</strong></p>
                        <p>${item.deficiencia}</p>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <p><strong>Recomendación:</strong></p>
                        <p>${item.recomendacion}</p>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <p><strong>Acciones Implementadas:</strong></p>
                        <p>${item.acciones || 'No especificado'}</p>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <p><strong>Comentarios:</strong></p>
                        <p>${item.comentarios || 'No hay comentarios'}</p>
                    </div>
                </div>
            `;
            
            // Mostrar el modal
            const modal = new bootstrap.Modal(document.getElementById('detailModal'));
            modal.show();
        }

        // Función para aplicar filtros
        function applyFilters() {
            const projectValue = projectFilter.value;
            const yearValue = yearFilter.value;
            const statusValue = statusFilter.value;
            const riskValue = riskFilter.value;
            
            filteredRecommendations = allRecommendations.filter(item => {
                return (!projectValue || item.proyecto === projectValue) &&
                       (!yearValue || item.año.toString() === yearValue) &&
                       (!statusValue || item.estado === statusValue) &&
                       (!riskValue || item.riesgo === riskValue);
            });
            
            // Actualizar la interfaz
            updateDashboardCards();
            initializeCharts();
            initializeDataTable();
        }

        // Función para limpiar filtros
        function clearFilters() {
            projectFilter.value = "";
            yearFilter.value = "";
            statusFilter.value = "";
            riskFilter.value = "";
            applyFilters();
        }

        // Función auxiliar para obtener la clase CSS del estado
        function getStatusClass(status) {
            const statusMap = {
                'CUMPLIDO': 'cumplido',
                'EN PROCESO': 'en-proceso',
                'NO CUMPLIDO': 'no-cumplido',
                'PENDIENTE': 'pendiente',
                'NO APLICA': 'no-aplica'
            };
            return statusMap[status] || 'pendiente';
        }

        // Función auxiliar para obtener la clase CSS del riesgo
        function getRiskBadgeClass(risk) {
            const riskMap = {
                'ALTO': 'danger',
                'MEDIO': 'warning',
                'BAJO': 'success'
            };
            return riskMap[risk] || 'secondary';
        }

        // Función para exportar datos
        async function exportToExcel() {
            try {
                loadingText.textContent = "Generando archivo Excel...";
                loadingOverlay.style.display = 'flex';
                
                const workbook = new ExcelJS.Workbook();
                const worksheet = workbook.addWorksheet('Recomendaciones');
                
                // Definir columnas
                worksheet.columns = [
                    { header: 'Proyecto', key: 'proyecto', width: 20 },
                    { header: 'Año', key: 'año', width: 10 },
                    { header: 'Nivel de Riesgo', key: 'riesgo', width: 15 },
                    { header: 'Deficiencia', key: 'deficiencia', width: 30 },
                    { header: 'Recomendación', key: 'recomendacion', width: 40 },
                    { header: 'Estado', key: 'estado', width: 15 },
                    { header: 'Responsable', key: 'responsable', width: 20 },
                    { header: 'Fecha Seguimiento', key: 'fechaSeguimiento', width: 15 }
                ];
                
                // Agregar datos
                worksheet.addRows(filteredRecommendations);
                
                // Aplicar formato a la cabecera
                worksheet.getRow(1).eachCell((cell) => {
                    cell.font = { bold: true };
                    cell.fill = {
                        type: 'pattern',
                        pattern: 'solid',
                        fgColor: { argb: 'FF2c7d32' }
                    };
                    cell.font = { color: { argb: 'FFFFFFFF' }, bold: true };
                });
                
                // Generar blob y descargar
                const buffer = await workbook.xlsx.writeBuffer();
                const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `Recomendaciones_FIAS_${new Date().toISOString().split('T')[0]}.xlsx`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                loadingOverlay.style.display = 'none';
            } catch (error) {
                console.error("Error exportando a Excel:", error);
                loadingOverlay.style.display = 'none';
                alert("Error al exportar: " + error.message);
            }
        }

        // Función para generar datos de ejemplo (simulación)
        function generateSampleData() {
            const proyectos = [
                "Auditoría Financiera 2023", 
                "Revisión de Contratos", 
                "Evaluación de Procesos TI",
                "Auditoría de Cumplimiento",
                "Revisión de Nóminas"
            ];
            
            const estados = ["CUMPLIDO", "EN PROCESO", "NO CUMPLIDO", "PENDIENTE"];
            const riesgos = ["ALTO", "MEDIO", "BAJO"];
            const responsables = ["Juan Pérez", "María García", "Carlos López", "Ana Martínez", "Pedro Rodríguez"];
            
            const data = [];
            
            for (let i = 1; i <= 50; i++) {
                const proyecto = proyectos[Math.floor(Math.random() * proyectos.length)];
                const año = 2020 + Math.floor(Math.random() * 4);
                const riesgo = riesgos[Math.floor(Math.random() * riesgos.length)];
                const estado = estados[Math.floor(Math.random() * estados.length)];
                const responsable = responsables[Math.floor(Math.random() * responsables.length)];
                
                data.push({
                    id: i,
                    proyecto: proyecto,
                    año: año,
                    riesgo: riesgo,
                    deficiencia: `Deficiencia ${i} en ${proyecto}`,
                    recomendacion: `Recomendación ${i} para abordar la deficiencia identificada`,
                    estado: estado,
                    responsable: responsable,
                    fechaSeguimiento: new Date(2023, Math.floor(Math.random() * 12), Math.floor(Math.random() * 28) + 1).toLocaleDateString(),
                    acciones: `Acciones implementadas ${i}`,
                    comentarios: `Comentarios adicionales sobre el seguimiento ${i}`
                });
            }
            
            return data;
        }

        // Event Listeners
        loginBtn.addEventListener('click', handleLogin);
        logoutBtn.addEventListener('click', handleLogout);
        refreshDataBtn.addEventListener('click', loadExcelData);
        clearFiltersBtn.addEventListener('click', clearFilters);
        exportBtn.addEventListener('click', exportToExcel);

        projectFilter.addEventListener('change', applyFilters);
        yearFilter.addEventListener('change', applyFilters);
        statusFilter.addEventListener('change', applyFilters);
        riskFilter.addEventListener('change', applyFilters);

        // Inicializar la aplicación
        async function initializeApp() {
            try {
                // Verificar si estamos en localhost (para desarrollo)
                const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
                
                // Verificar si hay una respuesta de autenticación
                const response = await msalInstance.handleRedirectPromise();
                
                if (response) {
                    // Usuario autenticado, cargar datos
                    await loadExcelData();
                } else {
                    // Verificar si hay cuentas en caché
                    const accounts = msalInstance.getAllAccounts();
                    
                    if (accounts.length > 0) {
                        // Hay una sesión activa, cargar datos
                        await loadExcelData();
                    } else {
                        // No hay sesión activa, mostrar UI de autenticación
                        showAuthUI();
                        loadingOverlay.style.display = 'none';
                    }
                }
            } catch (error) {
                console.error("Error inicializando la aplicación:", error);
                
                if (error.errorCode === "invalid_client") {
                    showConfigUI();
                } else {
                    loadingOverlay.style.display = 'none';
                    alert("Error inicializando la aplicación: " + error.message);
                    showAuthUI();
                }
            }
        }

        // Iniciar la aplicación cuando el DOM esté listo
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>
