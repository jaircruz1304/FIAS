<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Seguimiento de Recomendaciones - FIAS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.5/css/dataTables.bootstrap5.min.css">
    <style>
        :root {
            --fias-primary: #2c7d32;
            --fias-secondary: #8bc34a;
            --fias-accent: #ffc107;
        }
        body { background-color: #f8f9fa; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .navbar { background-color: var(--fias-primary); }
        .card-header { background-color: var(--fias-primary); color: white; }
        .status-badge { padding: 0.5em 1em; border-radius: 20px; font-weight: 600; }
        .status-en-proceso { background-color: #fff3cd; color: #856404; }
        .status-cumplido { background-color: #d4edda; color: #155724; }
        .status-no-cumplido { background-color: #f8d7da; color: #721c24; }
        .status-pendiente { background-color: #cce5ff; color: #004085; }
        .status-no-aplica { background-color: #e2e3e5; color: #383d41; }
        .risk-high { border-left: 5px solid #dc3545; }
        .risk-medium { border-left: 5px solid #ffc107; }
        .risk-low { border-left: 5px solid #28a745; }
        .dashboard-card { transition: transform 0.3s; border: none; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); }
        .dashboard-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1); }
        .chart-container { position: relative; height: 250px; }
        .progress { height: 10px; }
        .filter-section { background-color: white; border-radius: 8px; padding: 15px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05); }
        .logo-container { display: flex; align-items: center; gap: 10px; }
        .logo-icon { font-size: 24px; color: white; }
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.8); display: flex; justify-content: center; align-items: center; z-index: 9999; }
        .spinner-border { width: 3rem; height: 3rem; }
        .auth-container { max-width: 500px; margin: 50px auto; padding: 20px; background: white; border-radius: 8px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); }
        .config-help { background-color: #f8f9fa; border-left: 4px solid #0d6efd; padding: 15px; margin-top: 20px; }
        .no-data-message { text-align: center; padding: 40px; color: #6c757d; }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="text-center">
            <div class="spinner-border text-success" role="status">
                <span class="visually-hidden">Cargando...</span>
            </div>
            <p class="mt-3" id="loadingText">Conectando con Excel Online...</p>
        </div>
    </div>

    <div id="authContainer" class="auth-container" style="display: none;">
        <div class="text-center mb-4">
            <i class="fas fa-leaf fa-3x text-success"></i>
            <h3 class="mt-2">Autenticación requerida</h3>
            <p>Para acceder al dashboard de recomendaciones, necesita autenticarse con su cuenta de Office 365.</p>
        </div>
        <button id="loginBtn" class="btn btn-success w-100">
            <i class="fas fa-sign-in-alt me-2"></i> Iniciar sesión con Microsoft
        </button>
        <div class="mt-3 text-center">
            <small class="text-muted">Utilice su cuenta corporativa de FIAS</small>
        </div>
    </div>

    <div id="mainContent" style="display: none;">
        <nav class="navbar navbar-expand-lg navbar-dark">
            <div class="container">
                <div class="logo-container">
                    <i class="fas fa-leaf logo-icon"></i>
                    <a class="navbar-brand" href="#">FIAS - Seguimiento de Recomendaciones</a>
                </div>
                <div class="ms-auto">
                    <button class="btn btn-outline-light btn-sm me-2" id="refreshData">
                        <i class="fas fa-sync-alt me-1"></i> Actualizar
                    </button>
                    <button class="btn btn-outline-light btn-sm" id="logoutBtn">
                        <i class="fas fa-sign-out-alt me-1"></i> Cerrar sesión
                    </button>
                </div>
            </div>
        </nav>

        <div class="container mt-4">
            <div class="row mb-4">
                <div class="col-12">
                    <div class="filter-section">
                        <div class="row">
                            <div class="col-md-3 mb-2">
                                <label for="projectFilter" class="form-label">Proyecto</label>
                                <select class="form-select" id="projectFilter"><option value="">Todos los proyectos</option></select>
                            </div>
                            <div class="col-md-3 mb-2">
                                <label for="yearFilter" class="form-label">Año</label>
                                <select class="form-select" id="yearFilter"><option value="">Todos los años</option></select>
                            </div>
                            <div class="col-md-3 mb-2">
                                <label for="statusFilter" class="form-label">Estado</label>
                                <select class="form-select" id="statusFilter"><option value="">Todos los estados</option></select>
                            </div>
                            <div class="col-md-3 mb-2">
                                <label for="riskFilter" class="form-label">Nivel de Riesgo</label>
                                <select class="form-select" id="riskFilter">
                                    <option value="">Todos los niveles</option>
                                    <option value="ALTO">ALTO</option>
                                    <option value="MEDIO">MEDIO</option>
                                    <option value="BAJO">BAJO</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row mb-4" id="dashboardCards">
                </div>

            <div class="row mb-4">
                <div class="col-md-6 mb-3">
                    <div class="card dashboard-card">
                        <div class="card-header"><h5 class="mb-0">Recomendaciones por Estado</h5></div>
                        <div class="card-body"><div class="chart-container"><canvas id="statusChart"></canvas></div></div>
                    </div>
                </div>
                <div class="col-md-6 mb-3">
                    <div class="card dashboard-card">
                        <div class="card-header"><h5 class="mb-0">Recomendaciones por Nivel de Riesgo</h5></div>
                        <div class="card-body"><div class="chart-container"><canvas id="riskChart"></canvas></div></div>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-12">
                    <div class="card dashboard-card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">Lista de Recomendaciones</h5>
                            <button class="btn btn-sm btn-outline-light" id="exportBtn"><i class="fas fa-download me-1"></i> Exportar</button>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table id="recommendationsTable" class="table table-hover table-striped" style="width:100%;">
                                    <thead>
                                        <tr>
                                            <th>Proyecto</th>
                                            <th>Año</th>
                                            <th>Riesgo</th>
                                            <th>Deficiencia</th>
                                            <th>Recomendación</th>
                                            <th>Estado</th>
                                            <th>Responsable</th>
                                            <th>Fecha Seguimiento</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <footer class="bg-dark text-white mt-5 py-4">
            <div class="container text-center">
                <p>&copy; 2023 FIAS. Todos los derechos reservados.</p>
                <p class="small">Auditoría Interna - Desarrollado por Jair Cruz | Última actualización: <span id="lastUpdate"></span></p>
            </div>
        </footer>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.5/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.5/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://alcdn.msauth.net/browser/2.32.0/js/msal-browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <script>
        const msalConfig = {
            auth: {
                clientId: "deff0a8a-9d8b-4463-8d8f-382b82476757",
                authority: "https://login.microsoftonline.com/5e23e4af-237d-4d97-bf6e-dca808015787",
                redirectUri: window.location.origin
            },
            cache: {
                cacheLocation: "sessionStorage",
                storeAuthStateInCookie: false
            }
        };

        const msalInstance = new msal.PublicClientApplication(msalConfig);
        let accessToken = null;
        
        // === CAMBIO 1: Configuración de la conexión a SharePoint ===
        // Reemplaza estos valores con los que obtuviste del Probador de Graph
        const SHAREPOINT_SITE_ID = "fiasec.sharepoint.com,8a7d7099-a8a2-4638-b615-5e608149877b,4c947814-c36f-4c57-8149-a1b635c91b53"; 
        const EXCEL_ITEM_ID = "01GNSA2LMLZ3LIQ2SDWVCYDRUJWVAAV4NC"; 
        const EXCEL_SHEET_NAME = "RECOMENDACIONES AUD EXTERNA";
        
        // Variables globales
        let allRecommendationsData = [];
        let table;
        let statusChart, riskChart;
        
        async function initializeApp() {
            showLoading(true);
            try {
                const accounts = msalInstance.getAllAccounts();
                if (accounts.length > 0) {
                    await acquireToken();
                    document.getElementById('authContainer').style.display = 'none';
                    document.getElementById('mainContent').style.display = 'block';
                    await loadDataFromExcel();
                } else {
                    document.getElementById('authContainer').style.display = 'block';
                }
            } catch (error) {
                console.error('Error inicializando:', error);
                document.getElementById('authContainer').style.display = 'block';
            } finally {
                showLoading(false);
            }
        }

        async function acquireToken() {
            const accounts = msalInstance.getAllAccounts();
            if (accounts.length === 0) throw new Error("No hay cuentas activas");
            
            const silentRequest = {
                scopes: ["Sites.Read.All"], // Permiso necesario para leer archivos de SharePoint
                account: accounts[0]
            };
            
            try {
                const response = await msalInstance.acquireTokenSilent(silentRequest);
                accessToken = response.accessToken;
            } catch (error) {
                if (error instanceof msal.InteractionRequiredAuthError) {
                    const response = await msalInstance.acquireTokenPopup(silentRequest);
                    accessToken = response.accessToken;
                } else {
                    throw error;
                }
            }
        }

        async function loadDataFromExcel() {
            showLoading(true, "Cargando datos desde Excel...");
            try {
                if (!accessToken) await acquireToken();
                
                // === CAMBIO 2: URL de Graph API apuntando directamente al archivo en SharePoint ===
                const graphUrl = `https://graph.microsoft.com/v1.0/sites/${SHAREPOINT_SITE_ID}/drive/items/${EXCEL_ITEM_ID}/workbook/worksheets('${EXCEL_SHEET_NAME}')/usedRange`;

                const response = await fetch(graphUrl, {
                    headers: { Authorization: `Bearer ${accessToken}` }
                });

                if (!response.ok) throw new Error(`Error ${response.status}: ${response.statusText}`);

                const data = await response.json();
                allRecommendationsData = processExcelData(data.values);
                
                if (allRecommendationsData.length === 0) throw new Error("No se encontraron datos válidos en Excel.");
                
                setupDashboard();
                updateLastUpdateTime();
                
            } catch (error) {
                console.error('Error cargando datos:', error);
                alert('Error al cargar datos: ' + error.message);
            } finally {
                showLoading(false);
            }
        }
        
        function processExcelData(rows) {
            if (!rows || rows.length < 2) return []; // Necesita cabecera + al menos una fila de datos
            
            const headers = rows[0].map(h => h.trim().toLowerCase());
            const dataRows = rows.slice(1);
            
            // Mapeo flexible de posibles nombres de columnas
            const getIndex = (possibleNames) => {
                for (const name of possibleNames) {
                    const index = headers.indexOf(name.toLowerCase());
                    if (index !== -1) return index;
                }
                return -1;
            };

            const projectIdx = getIndex(['Proyecto', 'PROYECTO']);
            const yearIdx = getIndex(['Año', 'AÑO']);
            const riskIdx = getIndex(['Riesgo', 'Nivel de Riesgo']);
            const deficiencyIdx = getIndex(['Deficiencia', 'Deficiencia de Control Interno']);
            const recommendationIdx = getIndex(['Recomendacion', 'Recomendación']);
            const statusIdx = getIndex(['Estado', 'ESTADO']);
            const responsibleIdx = getIndex(['Responsable']);
            const dateIdx = getIndex(['Fecha de seguimiento', 'FechaSeguimiento']);

            return dataRows.map(row => ({
                proyecto: row[projectIdx] || '',
                año: row[yearIdx] || '',
                riesgo: (row[riskIdx] || '').toUpperCase(),
                deficiencia: row[deficiencyIdx] || '',
                recomendacion: row[recommendationIdx] || '',
                estado: row[statusIdx] || '',
                responsable: row[responsibleIdx] || '',
                fechaSeguimiento: row[dateIdx] || ''
            })).filter(item => item.proyecto); // Filtrar filas vacías
        }

        function setupDashboard() {
            updateFilters();
            initDataTable();
            
            // === CAMBIO 3: Llamada inicial al dashboard con todos los datos ===
            updateDashboardUI(allRecommendationsData);
        }
        
        // === CAMBIO 4: Función centralizada para actualizar el UI del dashboard ===
        // Acepta una fuente de datos (dataSource) para ser dinámica
        function updateDashboardUI(dataSource) {
            updateDashboardCards(dataSource);
            updateCharts(dataSource);
        }

        function updateDashboardCards(dataSource) {
            const total = dataSource.length;
            const cumplido = dataSource.filter(item => item.estado && item.estado.includes("Cumplido")).length;
            const enProceso = dataSource.filter(item => item.estado && item.estado.includes("En Proceso")).length;
            const noCumplido = dataSource.filter(item => item.estado && item.estado.includes("No Cumplido")).length;
            
            const cumplidoPercent = total > 0 ? Math.round((cumplido / total) * 100) : 0;
            
            document.getElementById('dashboardCards').innerHTML = `
                <div class="col-md-3 mb-3"><div class="card dashboard-card text-center"><div class="card-body">
                    <h5 class="card-title">Total Recomendaciones</h5><h2 class="card-text text-primary">${total}</h2>
                </div></div></div>
                <div class="col-md-3 mb-3"><div class="card dashboard-card text-center"><div class="card-body">
                    <h5 class="card-title">Cumplidas</h5><h2 class="card-text text-success">${cumplido}</h2>
                </div></div></div>
                <div class="col-md-3 mb-3"><div class="card dashboard-card text-center"><div class="card-body">
                    <h5 class="card-title">En Proceso</h5><h2 class="card-text text-warning">${enProceso}</h2>
                </div></div></div>
                <div class="col-md-3 mb-3"><div class="card dashboard-card text-center"><div class="card-body">
                    <h5 class="card-title">No Cumplidas</h5><h2 class="card-text text-danger">${noCumplido}</h2>
                </div></div></div>
            `;
        }

        function updateFilters() {
            const populateSelect = (elementId, values) => {
                const select = document.getElementById(elementId);
                select.innerHTML = `<option value="">Todos los ${select.previousElementSibling.textContent.toLowerCase()}</option>`;
                values.sort().forEach(value => {
                    select.innerHTML += `<option value="${value}">${value}</option>`;
                });
            };
            
            populateSelect('projectFilter', [...new Set(allRecommendationsData.map(item => item.proyecto))]);
            populateSelect('yearFilter', [...new Set(allRecommendationsData.map(item => item.año))]);
            populateSelect('statusFilter', [...new Set(allRecommendationsData.map(item => item.estado))]);
        }
        
        function initDataTable() {
            if ($.fn.DataTable.isDataTable('#recommendationsTable')) {
                table.destroy();
            }
            
            table = $('#recommendationsTable').DataTable({
                data: allRecommendationsData,
                columns: [
                    { data: 'proyecto' }, { data: 'año' },
                    { 
                        data: 'riesgo',
                        render: data => {
                            const riskClass = data === 'ALTO' ? 'danger' : data === 'MEDIO' ? 'warning' : 'success';
                            return `<span class="badge bg-${riskClass}">${data || 'N/A'}</span>`;
                        }
                    },
                    { data: 'deficiencia', render: data => data.length > 80 ? data.substr(0, 80) + '...' : data },
                    { data: 'recomendacion', render: data => data.length > 80 ? data.substr(0, 80) + '...' : data },
                    { data: 'estado' }, { data: 'responsable' }, { data: 'fechaSeguimiento' }
                ],
                language: { url: '//cdn.datatables.net/plug-ins/1.13.5/i18n/es-ES.json' },
                pageLength: 10,
                responsive: true
            });
            
            // Filtro personalizado
            $.fn.dataTable.ext.search.push((settings, data, dataIndex) => {
                const project = $('#projectFilter').val();
                const year = $('#yearFilter').val();
                const status = $('#statusFilter').val();
                const risk = $('#riskFilter').val();
                
                const rowData = allRecommendationsData[dataIndex];
                
                if (project && rowData.proyecto !== project) return false;
                if (year && rowData.año.toString() !== year) return false;
                if (status && rowData.estado !== status) return false;
                if (risk && rowData.riesgo !== risk) return false;
                
                return true;
            });

            $('#projectFilter, #yearFilter, #statusFilter, #riskFilter').on('change', () => table.draw());

            // === CAMBIO 5: Evento que se dispara al filtrar la tabla ===
            table.on('draw.dt', () => {
                // Obtener solo los datos que coinciden con el filtro actual
                const filteredData = table.rows({ search: 'applied' }).data().toArray();
                // Actualizar el dashboard con los datos filtrados
                updateDashboardUI(filteredData);
            });
        }
        
        function updateCharts(dataSource) {
            const statusCounts = dataSource.reduce((acc, item) => {
                const estado = item.estado || 'Sin especificar';
                acc[estado] = (acc[estado] || 0) + 1;
                return acc;
            }, {});

            const riskCounts = dataSource.reduce((acc, item) => {
                const riesgo = item.riesgo || 'Sin especificar';
                acc[riesgo] = (acc[riesgo] || 0) + 1;
                return acc;
            }, {});

            const createOrUpdateChart = (chartInstance, chartId, type, labels, data, backgroundColors, label) => {
                const ctx = document.getElementById(chartId).getContext('2d');
                if (chartInstance) {
                    chartInstance.data.labels = labels;
                    chartInstance.data.datasets[0].data = data;
                    chartInstance.data.datasets[0].backgroundColor = backgroundColors;
                    chartInstance.update();
                    return chartInstance;
                }
                return new Chart(ctx, {
                    type: type,
                    data: {
                        labels: labels,
                        datasets: [{ label, data, backgroundColor: backgroundColors }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
                });
            };

            statusChart = createOrUpdateChart(statusChart, 'statusChart', 'doughnut', Object.keys(statusCounts), Object.values(statusCounts), ['#28a745', '#ffc107', '#dc3545', '#17a2b8', '#6c757d']);
            riskChart = createOrUpdateChart(riskChart, 'riskChart', 'bar', Object.keys(riskCounts), Object.values(riskCounts), ['#dc3545', '#ffc107', '#28a745', '#6c757d'], 'Recomendaciones por Riesgo');
        }

        function updateLastUpdateTime() {
            document.getElementById('lastUpdate').textContent = new Date().toLocaleString('es-ES');
        }

        function showLoading(show, text = 'Conectando...') {
            document.getElementById('loadingText').textContent = text;
            document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
        }

        // Event Listeners
        document.getElementById('loginBtn').addEventListener('click', async () => {
            showLoading(true);
            try {
                await msalInstance.loginPopup({ scopes: ["Sites.Read.All"] });
                await initializeApp();
            } catch (error) {
                console.error('Error en login:', error);
                alert('Error al iniciar sesión: ' + error.message);
                showLoading(false);
            }
        });

        document.getElementById('logoutBtn').addEventListener('click', () => msalInstance.logoutPopup());
        document.getElementById('refreshData').addEventListener('click', loadDataFromExcel);
        document.getElementById('exportBtn').addEventListener('click', () => {
            const filteredData = table.rows({ search: 'applied' }).data().toArray();
            const ws = XLSX.utils.json_to_sheet(filteredData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Recomendaciones Filtradas");
            XLSX.writeFile(wb, "Recomendaciones_FIAS_Filtradas.xlsx");
        });

        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>
