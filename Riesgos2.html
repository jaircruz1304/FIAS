<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Riesgos - FIAS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.5/css/dataTables.bootstrap5.min.css">
    <style>
        :root {
            --fias-primary: #2c7d32; /* Verde Oscuro FIAS */
            --fias-secondary: #8bc34a; /* Verde Claro FIAS */
            --fias-accent: #ffc107; /* Amarillo */
        }
        
        body {
            background-color: #f0f2f5;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .navbar {
            background-color: var(--fias-primary);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        /* Dashboard Cards */
        .dashboard-card {
            transition: transform 0.3s, box-shadow 0.3s;
            border-radius: 10px;
            overflow: hidden;
            background-color: #fff;
        }

        .dashboard-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15);
        }

        .card-header {
            background-color: var(--fias-primary);
            color: white;
            padding: 10px 15px;
            font-size: 1.1rem;
            border-bottom: none;
        }

        /* DataTables Styling */
        #riskTable_wrapper .row:first-child {
            margin-bottom: 15px;
        }

        .dataTables_length, .dataTables_filter, .dataTables_info, .dataTables_paginate {
            padding: 10px 0;
        }

        .dataTables_filter input {
            border-radius: 5px;
            border: 1px solid #ced4da;
            padding: 5px 10px;
        }

        table.dataTable thead th {
            background-color: var(--fias-secondary);
            color: white;
            border-color: #7bb839 !important;
        }

        /* Status Badges */
        .badge-alto { background-color: #dc3545; color: white; } /* Rojo */
        .badge-medio { background-color: #ffc107; color: #333; } /* Amarillo */
        .badge-bajo { background-color: #0d6efd; color: white; } /* Azul */
        .badge-muy-bajo { background-color: #28a745; color: white; } /* Verde */

        /* Custom Filters */
        .filter-section {
            padding: 15px;
            background-color: #fff;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
        }
        
        .modal-header {
            background-color: var(--fias-primary);
            color: white;
        }
        
        .modal-title i {
            color: var(--fias-accent);
        }
    </style>
</head>
<body>

    <nav class="navbar navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="fas fa-chart-line me-2"></i> Dashboard de Riesgos FIAS
            </a>
            <button id="exportBtn" class="btn btn-warning btn-sm">
                <i class="fas fa-file-export me-1"></i> Exportar Riesgos Filtrados
            </button>
        </div>
    </nav>

    <div class="container-fluid py-4">
        
        <div class="row mb-4 g-3">
            <div class="col-md-3">
                <div class="dashboard-card p-3">
                    <h5 class="text-uppercase text-danger fw-bold"><i class="fas fa-exclamation-triangle me-2"></i> Riesgos Altos</h5>
                    <h2 class="display-4 fw-light text-end" id="count-alto">0</h2>
                </div>
            </div>
            <div class="col-md-3">
                <div class="dashboard-card p-3">
                    <h5 class="text-uppercase text-warning fw-bold"><i class="fas fa-bell me-2"></i> Riesgos Medios</h5>
                    <h2 class="display-4 fw-light text-end" id="count-medio">0</h2>
                </div>
            </div>
            <div class="col-md-3">
                <div class="dashboard-card p-3">
                    <h5 class="text-uppercase text-primary fw-bold"><i class="fas fa-info-circle me-2"></i> Riesgos Bajos</h5>
                    <h2 class="display-4 fw-light text-end" id="count-bajo">0</h2>
                </div>
            </div>
            <div class="col-md-3">
                <div class="dashboard-card p-3">
                    <h5 class="text-uppercase text-success fw-bold"><i class="fas fa-check-circle me-2"></i> Riesgos Muy Bajos</h5>
                    <h2 class="display-4 fw-light text-end" id="count-muy-bajo">0</h2>
                </div>
            </div>
        </div>

        <div class="filter-section mb-4">
            <div class="row g-3 align-items-end">
                <div class="col-md-4">
                    <label for="fileInput" class="form-label fw-bold"><i class="fas fa-upload me-1"></i> Cargar Matriz de Riesgos (.xlsx / .csv)</label>
                    <input class="form-control" type="file" id="fileInput" accept=".xlsx, .csv">
                </div>
                <div class="col-md-3">
                    <label for="localidadFilter" class="form-label fw-bold">Filtrar por Localidad</label>
                    <select class="form-select" id="localidadFilter" disabled>
                        <option value="">Todas las Localidades</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="factorFilter" class="form-label fw-bold">Filtrar por Factor de Riesgo</label>
                    <select class="form-select" id="factorFilter" disabled>
                        <option value="">Todos los Factores</option>
                    </select>
                </div>
                <div class="col-md-2 d-grid">
                    <button class="btn btn-secondary" id="resetFiltersBtn" disabled>
                        <i class="fas fa-filter-circle-xmark me-1"></i> Limpiar Filtros
                    </button>
                </div>
            </div>
        </div>

        <div class="card shadow-sm">
            <div class="card-header">
                <i class="fas fa-table me-2"></i> Matriz de Riesgos Residuales
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table id="riskTable" class="table table-striped table-hover w-100">
                        <thead>
                            <tr>
                                <th>Ver</th>
                                <th>Proyecto</th>
                                <th>Localidad</th>
                                <th>Factor</th>
                                <th>Riesgo Residual</th>
                                <th>Nivel Residual</th>
                                <th>Responsable</th>
                                <th>Fecha Seguimiento (AI)</th>
                            </tr>
                        </thead>
                        <tbody>
                            </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="detailModal" tabindex="-1" aria-labelledby="detailModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="detailModalLabel"><i class="fas fa-magnifying-glass me-2"></i> Detalle del Riesgo</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row g-4">
                        <div class="col-lg-6">
                            <h6><i class="fas fa-clipboard-list me-2 text-primary"></i> Información General</h6>
                            <p><strong>Proyecto:</strong> <span id="modal-proyecto" class="d-block p-2 bg-light rounded border"></span></p>
                            <p><strong>Localidad:</strong> <span id="modal-localidad" class="d-block p-2 bg-light rounded border"></span></p>
                            <p><strong>Factor de Riesgo:</strong> <span id="modal-factor" class="d-block p-2 bg-light rounded border"></span></p>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <strong>Riesgo Inherente:</strong> <span id="modal-inherente" class="d-block p-2 bg-light rounded border"></span>
                                </div>
                                <div class="col-md-6">
                                    <strong>Nivel de Riesgo Inherente:</strong> <span id="modal-inherente-nivel" class="d-block p-2 bg-light rounded border"></span>
                                </div>
                            </div>
                            <div class="row g-3 mt-3">
                                <div class="col-md-6">
                                    <strong>Riesgo Residual:</strong> <span id="modal-residual" class="d-block p-2 bg-light rounded border"></span>
                                </div>
                                <div class="col-md-6">
                                    <strong>Nivel de Riesgo Residual:</strong> <span id="modal-residual-nivel" class="d-block p-2 bg-light rounded border"></span>
                                </div>
                            </div>
                            <p class="mt-3"><strong>Responsable:</strong> <span id="modal-responsable" class="d-block p-2 bg-light rounded border"></span></p>
                        </div>
                        
                        <div class="col-lg-6">
                            <h6><i class="fas fa-exclamation me-2 text-danger"></i> Detalle del Evento</h6>
                            <p><strong>Evento de Riesgo:</strong> <span id="modal-event" class="d-block p-2 bg-light rounded border"></span></p>
                            <p><strong>Causa:</strong> <span id="modal-cause" class="d-block p-2 bg-light rounded border"></span></p>
                            <p><strong>Efecto / Consecuencia:</strong> <span id="modal-effect" class="d-block p-2 bg-light rounded border"></span></p>
                            
                            <h6><i class="fas fa-shield-alt me-2 text-success"></i> Control y Seguimiento</h6>
                            <p><strong>Descripción del Control:</strong> <span id="modal-action" class="d-block p-2 bg-light rounded border"></span></p>
                            <p><strong>Fecha de Seguimiento (AI):</strong> <span id="modal-date" class="d-block p-2 bg-light rounded border"></span></p>
                            <hr>
                            
                            <h6><i class="fas fa-search me-2 text-info"></i> Seguimiento y Auditoría Interna</h6>
                            
                            <p><strong>Evidencia del Cumplimiento (Responsable):</strong> <span id="modal-evidencia" class="d-block p-2 bg-light rounded border text-break"></span></p>
                            
                            <div class="row g-3 mb-3">
                                <div class="col-md-6">
                                    <strong>Evaluación de la Efectividad del Control (AI):</strong> 
                                    <span id="modal-evaluacion" class="d-block p-2 bg-light rounded border"></span>
                                </div>
                                <div class="col-md-6">
                                    <strong>Observación (Responsable o AI):</strong> 
                                    <span id="modal-observacion" class="d-block p-2 bg-light rounded border"></span>
                                </div>
                            </div>
                            </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>


    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.5/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.5/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    
    <script>
        let table;
        let originalData = [];
        let allLocalidades = new Set();
        let allFactores = new Set();
        
        // Función para obtener la clase de color para el nivel de riesgo residual
        function getBadgeClass(nivel) {
            const lowerNivel = nivel ? nivel.toLowerCase() : '';
            if (lowerNivel.includes('alto')) return 'badge-alto';
            if (lowerNivel.includes('medio')) return 'badge-medio';
            if (lowerNivel.includes('bajo')) return 'badge-bajo';
            if (lowerNivel.includes('muy bajo')) return 'badge-muy-bajo';
            return 'bg-secondary';
        }
        
        // Mapeo de encabezados de la Matriz de Riesgo a nombres de campos en minúsculas (camelCase)
        const mapHeaders = {
            'PROYECTO': 'proyecto',
            'PROYECTO- LOCALIDAD': 'localidad',
            'Factor de Riesgo': 'factorRiesgo',
            'Nivel de Riesgo inherente': 'riesgoInherenteNivel',
            'Nivel de Riesgo residual': 'riesgoResidualNivel',
            'Riesgo Residual': 'riesgoResidual',
            'Riesgo inherente': 'riesgoInherente',
            'Valor total': 'valorTotal',
            'Descripción del evento de Riesgo\n¿Qué podría suceder?': 'eventoRiesgo',
            'Causa\n¿Porqué podría suceder?': 'causa',
            'Efercto \nConsecuencia': 'efecto',
            'Descripción del Control': 'planAccion',
            'Responsable': 'responsable',
            'Fecha de seguimiento (Columna de Auditoría Interna)': 'fechaSeguimiento',
            // ===============================================
            // INICIO: CAMPOS DE AUDITORÍA INTERNA AÑADIDOS
            // ===============================================
            'Evidencia del cumplimiento . ( La evidencia la coloca el responsable)': 'evidenciaCumplimiento',
            'Evaluación de la efectividad del control. (Columna de Auditoría Interna)': 'evaluacionEfectividad',
            'Observación (Puede colocar el responsable o AI)': 'observacionAI',
            // ===============================================
            // FIN: CAMPOS DE AUDITORÍA INTERNA AÑADIDOS
            // ===============================================
        };
        
        function processExcelData(data) {
            const mappedData = [];
            
            // Encuentra los encabezados relevantes y su orden
            const headers = Object.keys(data[0]);
            const headerMap = {};
            
            headers.forEach(header => {
                // Limpieza de encabezado para comparación (ej. remueve saltos de línea y espacios extras)
                const cleanHeader = header.trim().replace(/\s+/g, ' '); 
                const mappedName = mapHeaders[cleanHeader] || mapHeaders[header.trim()];
                
                if (mappedName) {
                    headerMap[header] = mappedName;
                }
            });
            
            data.forEach(row => {
                const risk = {};
                let isValidRow = false; // Solo procesar filas con datos de riesgo (ej. proyecto o localidad)
                
                for (const key in row) {
                    const mappedKey = headerMap[key];
                    if (mappedKey) {
                        let value = row[key];
                        // Limpieza básica de datos
                        if (typeof value === 'string') {
                            value = value.trim();
                        }
                        risk[mappedKey] = value;
                        
                        // Marca la fila como válida si tiene datos clave
                        if (mappedKey === 'proyecto' && value) {
                            isValidRow = true;
                        }
                    }
                }
                
                // Si la fila tiene datos de riesgo (columna 'proyecto') y tiene un nivel de riesgo residual
                if (isValidRow && risk.riesgoResidualNivel) {
                    mappedData.push(risk);
                    allLocalidades.add(risk.localidad);
                    allFactores.add(risk.factorRiesgo);
                }
            });
            
            return mappedData;
        }

        function loadFilters() {
            const localidadSelect = document.getElementById('localidadFilter');
            const factorSelect = document.getElementById('factorFilter');
            
            // Llenar filtro de Localidad
            localidadSelect.innerHTML = '<option value="">Todas las Localidades</option>';
            [...allLocalidades].sort().forEach(loc => {
                localidadSelect.innerHTML += `<option value="${loc}">${loc}</option>`;
            });
            
            // Llenar filtro de Factor de Riesgo
            factorSelect.innerHTML = '<option value="">Todos los Factores</option>';
            [...allFactores].sort().forEach(factor => {
                factorSelect.innerHTML += `<option value="${factor}">${factor}</option>`;
            });
            
            // Habilitar filtros
            localidadSelect.disabled = false;
            factorSelect.disabled = false;
            document.getElementById('resetFiltersBtn').disabled = false;
        }

        function updateRiskCounts(data) {
            const counts = { 'Alto': 0, 'Medio': 0, 'Bajo': 0, 'Muy Bajo': 0 };
            
            data.forEach(risk => {
                const nivel = risk.riesgoResidualNivel.toLowerCase();
                if (nivel.includes('alto')) counts['Alto']++;
                else if (nivel.includes('medio')) counts['Medio']++;
                else if (nivel.includes('bajo')) counts['Bajo']++;
                else if (nivel.includes('muy bajo')) counts['Muy Bajo']++;
            });
            
            document.getElementById('count-alto').textContent = counts['Alto'];
            document.getElementById('count-medio').textContent = counts['Medio'];
            document.getElementById('count-bajo').textContent = counts['Bajo'];
            document.getElementById('count-muy-bajo').textContent = counts['Muy Bajo'];
        }

        function applyFilters() {
            if (!table) return;

            const localidad = document.getElementById('localidadFilter').value;
            const factor = document.getElementById('factorFilter').value;

            // Filtro por Localidad (columna 2)
            table.column(2).search(localidad ? '^' + $.fn.dataTable.util.escapeRegex(localidad) + '$' : '', true, false).draw();
            
            // Filtro por Factor de Riesgo (columna 3)
            table.column(3).search(factor ? '^' + $.fn.dataTable.util.escapeRegex(factor) + '$' : '', true, false).draw();
            
            // Actualizar conteos con los datos visibles después del filtro
            const filteredData = table.rows({ search: 'applied' }).data().toArray().map(index => originalData[index[0]]);
            updateRiskCounts(filteredData);
        }

        function showRiskDetails(risk) {
            // Mapeo de información general
            document.getElementById('modal-proyecto').textContent = risk.proyecto;
            document.getElementById('modal-localidad').textContent = risk.localidad;
            document.getElementById('modal-factor').textContent = risk.factorRiesgo;
            document.getElementById('modal-responsable').textContent = risk.responsable;
            
            // Mapeo de niveles de riesgo
            document.getElementById('modal-inherente').textContent = risk.valorTotal || 'N/A';
            document.getElementById('modal-inherente-nivel').textContent = risk.riesgoInherenteNivel || 'N/A';
            document.getElementById('modal-residual').textContent = risk.riesgoResidual || 'N/A';
            document.getElementById('modal-residual-nivel').textContent = risk.riesgoResidualNivel || 'N/A';
            
            // Mapeo de detalle de evento y control
            document.getElementById('modal-event').textContent = risk.eventoRiesgo;
            document.getElementById('modal-cause').textContent = risk.causa;
            document.getElementById('modal-effect').textContent = risk.efecto;
            document.getElementById('modal-action').textContent = risk.planAccion;
            document.getElementById('modal-date').textContent = risk.fechaSeguimiento;
            
            // ===============================================
            // INICIO: CAMPOS DE AUDITORÍA INTERNA AÑADIDOS
            // ===============================================
            document.getElementById('modal-evidencia').textContent = risk.evidenciaCumplimiento || 'No registrada';
            document.getElementById('modal-evaluacion').textContent = risk.evaluacionEfectividad || 'Pendiente de Auditoría';
            document.getElementById('modal-observacion').textContent = risk.observacionAI || 'Sin observaciones';
            // ===============================================
            // FIN: CAMPOS DE AUDITORÍA INTERNA AÑADIDOS
            // ===============================================

            $('#detailModal').modal('show');
        }

        // Inicialización de la Tabla y Eventos
        $(document).ready(function() {
            const fileInput = document.getElementById('fileInput');

            fileInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (!file) {
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    
                    // Asumiendo que la matriz de riesgos está en la hoja 'Matriz de Riesgos LA-FT'
                    const sheetName = 'Matriz de Riesgos LA-FT'; 
                    const worksheet = workbook.Sheets[sheetName] || workbook.Sheets[workbook.SheetNames[0]]; // Usa el primero si no encuentra el nombre
                    
                    const json = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    
                    // Encontrar la fila que contiene los encabezados reales (ej. "PROYECTO")
                    let headerRowIndex = json.findIndex(row => row.some(cell => typeof cell === 'string' && cell.includes('PROYECTO')));
                    if (headerRowIndex === -1) {
                        // Fallback si no se encuentra "PROYECTO"
                        headerRowIndex = 0; 
                    }
                    
                    // Procesar a partir de la fila de encabezados
                    const dataWithHeaders = XLSX.utils.sheet_to_json(worksheet, { 
                        range: headerRowIndex, 
                        raw: false 
                    });

                    // Limpiar y mapear los datos
                    originalData = processExcelData(dataWithHeaders);

                    if ($.fn.DataTable.isDataTable('#riskTable')) {
                        table.destroy();
                    }
                    
                    // Crear la tabla DataTables
                    table = $('#riskTable').DataTable({
                        data: originalData,
                        columns: [
                            { 
                                data: null, 
                                defaultContent: '<button class="btn btn-sm btn-info view-btn" title="Ver Detalle"><i class="fas fa-eye"></i></button>',
                                orderable: false,
                                searchable: false
                            },
                            { data: 'proyecto' },
                            { data: 'localidad' },
                            { data: 'factorRiesgo' },
                            { 
                                data: 'riesgoResidual',
                                render: function(data, type, row) {
                                    return `<span class="fw-bold">${data}</span>`;
                                }
                            },
                            { 
                                data: 'riesgoResidualNivel',
                                render: function(data, type, row) {
                                    const badgeClass = getBadgeClass(data);
                                    return `<span class="badge ${badgeClass} p-2">${data}</span>`;
                                }
                            },
                            { data: 'responsable' },
                            { data: 'fechaSeguimiento' }
                        ],
                        order: [[5, 'asc']], // Ordenar por Nivel Residual al cargar
                        language: {
                            url: 'https://cdn.datatables.net/plug-ins/1.13.5/i18n/es-ES.json'
                        },
                        initComplete: function () {
                            // Inicializar conteos y filtros después de que la tabla se haya cargado
                            updateRiskCounts(originalData);
                            loadFilters();
                        }
                    });
                    
                    // Evento para abrir el modal de detalle
                    $('#riskTable tbody').on('click', '.view-btn', function() {
                        const data = table.row($(this).parents('tr')).data();
                        
                        // Encontrar el objeto de riesgo original basado en los datos de la fila de la tabla
                        const riskIndex = originalData.findIndex(r => 
                            r.proyecto === data.proyecto && 
                            r.localidad === data.localidad && 
                            r.riesgoResidualNivel === data.riesgoResidualNivel
                        );
                        
                        if (riskIndex !== -1) {
                            showRiskDetails(originalData[riskIndex]);
                        } else {
                            // Fallback, aunque 'data' debería ser suficiente si no se usa el índice de la fila.
                            showRiskDetails(data); 
                        }
                    });

                };
                reader.readAsArrayBuffer(file);
            });
            
            // Eventos de filtro
            document.getElementById('localidadFilter').addEventListener('change', applyFilters); 
            document.getElementById('factorFilter').addEventListener('change', applyFilters);
            document.getElementById('resetFiltersBtn').addEventListener('click', function() {
                document.getElementById('localidadFilter').value = '';
                document.getElementById('factorFilter').value = '';
                applyFilters(); // Aplica el filtro con valores vacíos
            });
            
            document.getElementById('exportBtn').addEventListener('click', function() {
                // Mapear solo los datos actualmente visibles/filtrados
                const exportData = table.rows({ search: 'applied' }).data().toArray().map(item => ({
                    'Proyecto': item.proyecto,
                    'Localidad': item.localidad,
                    'Factor de Riesgo': item.factorRiesgo,
                    'Nivel de Riesgo Inherente': item.riesgoInherenteNivel,
                    'Nivel de Riesgo Residual': item.riesgoResidualNivel, 
                    'Riesgo Residual Valor': item.riesgoResidual, 
                    'Evento de Riesgo': item.eventoRiesgo,
                    'Causa': item.causa,
                    'Efecto': item.efecto,
                    'Descripción del Control': item.planAccion,
                    'Responsable': item.responsable,
                    'Fecha de Seguimiento (AI)': item.fechaSeguimiento,
                    // ===============================================
                    // INICIO: CAMPOS DE AUDITORÍA INTERNA EXPORTADOS
                    // ===============================================
                    'Evidencia del cumplimiento': item.evidenciaCumplimiento,
                    'Evaluación de la efectividad del control (AI)': item.evaluacionEfectividad,
                    'Observación': item.observacionAI
                    // ===============================================
                    // FIN: CAMPOS DE AUDITORÍA INTERNA EXPORTADOS
                    // ===============================================
                }));
                const ws = XLSX.utils.json_to_sheet(exportData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Matriz_Riesgos_Residuales_FIAS");
                XLSX.writeFile(wb, "Matriz_Riesgos_Residuales_FIAS_Filtrado.xlsx");
            });
        });
    </script>
</body>
</html>
